<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>วิเคราะห์ธาตุเจ้าเรือน (Sadao Official)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --gold-main: #D4AF37; 
            --gold-dark: #AA8C2C;
            --green-deep: #1B4D3E; 
            --green-light: #2E7D32;
            --cream: #FFF8E1;
        }
        
        body { 
            font-family: 'Prompt', sans-serif; 
            background-color: #F5F5F0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23D4AF37' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            overflow-x: hidden; color: #333;
        }

        /* --- 3D Scene --- */
        .card-scene { width: 100%; max-width: 450px; margin: 0 auto; min-height: 100vh; perspective: 1500px; padding: 30px 20px; box-sizing: border-box; }
        .card-object { width: 100%; position: relative; transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .card-face { 
            width: 100%; border-radius: 30px; backface-visibility: hidden; 
            background: white; 
            box-shadow: 0 20px 60px rgba(27, 77, 62, 0.25), 0 0 0 1px rgba(212, 175, 55, 0.1) inset; 
            min-height: 850px; display: flex; flex-direction: column; overflow: hidden; 
        }
        .card-front { transform: rotateY(0deg); position: relative; background: linear-gradient(180deg, #FFFFFF 0%, #F9F9F9 100%); }
        .card-back { position: absolute; top: 0; left: 0; height: 100%; transform: rotateY(180deg); background: white; }
        .is-flipped { transform: rotateY(180deg); }

        /* --- Weather Effects Layer (Z-Index 0) --- */
        .weather-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.5; overflow: hidden; border-radius: 30px;}
        .theme-winter { background: linear-gradient(180deg, #E3F2FD 0%, #FFFFFF 80%); }
        .theme-summer { background: linear-gradient(180deg, #FFF8E1 0%, #FFFFFF 80%); }
        .theme-rain { background: linear-gradient(180deg, #ECEFF1 0%, #FFFFFF 80%); }

        /* Particles */
        .snowflake, .rain, .sun-glare { position: absolute; pointer-events: none; }
        .snowflake { width: 6px; height: 6px; background: white; border-radius: 50%; box-shadow: 0 0 5px rgba(255,255,255,0.8); animation: fall linear infinite; }
        .rain { width: 2px; height: 40px; background: linear-gradient(to bottom, transparent, rgba(0,100,255,0.5)); animation: fall 0.7s linear infinite; }
        .sun-glare { top: -100px; right: -100px; width: 400px; height: 400px; background: radial-gradient(circle, rgba(255,215,0,0.2) 0%, transparent 70%); animation: pulse 6s infinite ease-in-out; }
        
        @keyframes fall { from { transform: translateY(-100px); } to { transform: translateY(1000px); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }

        /* --- Content Layer (Z-Index 10) --- */
        .front-content { position: relative; z-index: 10; padding: 40px 25px; display: flex; flex-direction: column; height: 100%; }

        /* Logo */
        .logo-container { 
            width: 110px; height: 110px; margin: 0 auto 20px; 
            background: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            border: 3px solid var(--gold-main); 
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
            animation: floatLogo 4s ease-in-out infinite;
        }
        @keyframes floatLogo { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .logo-img { width: 90%; height: auto; object-fit: contain; }

        /* Inputs */
        .input-group { position: relative; margin-bottom: 25px; }
        .input-label { 
            position: absolute; top: -10px; left: 15px; 
            background: white; padding: 0 10px; 
            color: var(--green-deep); font-size: 13px; font-weight: bold; 
            border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 20;
        }
        .custom-select { 
            width: 100%; padding: 16px; border: 1.5px solid rgba(27, 77, 62, 0.2); 
            border-radius: 18px; font-family: 'Prompt'; font-size: 16px; color: #333; 
            background: rgba(255,255,255,0.9); outline: none; appearance: none;
            transition: all 0.3s;
        }
        .custom-select:focus { border-color: var(--gold-main); box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1); background: white; }

        /* Main Button */
        .btn-gold { 
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-light) 100%);
            color: white; border: none; padding: 18px; width: 100%; 
            border-radius: 18px; font-size: 18px; font-weight: bold; 
            box-shadow: 0 10px 25px rgba(27, 77, 62, 0.3); 
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; 
            position: relative; overflow: hidden;
        }
        .btn-gold:active { transform: scale(0.97); }

        /* Forecast Card (Glassmorphism) */
        .forecast-box { 
            margin-top: auto; 
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 24px; padding: 20px; 
            border: 1px solid rgba(255,255,255,0.8); 
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.05);
        }
        .forecast-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 8px; }
        .utu-badge { background: var(--green-deep); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 8px; }
        
        /* Result Page Header */
        .back-header { 
            padding: 50px 20px 40px; text-align: center; color: white; 
            border-radius: 0 0 40% 40% / 0 0 35px 35px; 
            position: relative; flex-shrink: 0; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .avatar-real { 
            width: 140px; height: 140px; margin: -5px auto 10px; 
            object-fit: contain; border-radius: 50%; background: white; 
            border: 4px solid rgba(255,255,255,0.5); 
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.2));
        }

        /* Result Content */
        .back-content { flex-grow: 1; overflow-y: auto; padding: 20px; margin-top: -30px; z-index: 10; padding-bottom: 40px; }
        
        /* Section with Like Button */
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; margin-top: 15px;
        }
        .section-title { 
            font-size: 15px; font-weight: bold; color: var(--green-deep); 
            display: flex; align-items: center;
        }
        .section-title i { margin-right: 8px; color: var(--gold-main); font-size: 18px; }
        
        /* Feedback Button */
        .btn-like {
            background: white; border: 1px solid #E0E0E0; 
            color: #999; padding: 4px 10px; border-radius: 20px; 
            font-size: 11px; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; gap: 4px;
        }
        .btn-like.active {
            background: var(--gold-main); border-color: var(--gold-main); color: white;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
        }
        .btn-like:hover { transform: translateY(-1px); }

        .detail-box { 
            background: #FAFAFA; border-radius: 16px; padding: 15px; 
            border-left: 4px solid var(--green-deep); 
            font-size: 13px; color: #555; line-height: 1.7; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        .food-tag { display: inline-block; padding: 6px 12px; margin: 0 6px 8px 0; background: white; border: 1px solid #E0E0E0; border-radius: 20px; font-size: 12px; color: #444; cursor: pointer; transition: all 0.2s; }
        .food-tag:hover { background: var(--gold-main); color: white; border-color: var(--gold-main); }

        .debug-info { font-size: 10px; color: rgba(255,255,255,0.7); margin-top: 5px; }
        
        /* Loading Overlay */
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 100; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px);}
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--green-deep); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner"></div>
        <p class="mt-4 text-sm text-green-900 font-bold">กำลังประมวลผล...</p>
    </div>

    <div class="card-scene">
        <div id="cardObject" class="card-object">
            
            <div id="cardFront" class="card-face card-front">
                <div id="weatherContainer" class="weather-container"></div>
                <div class="front-content">
                    
                    <div class="text-center mb-6 relative z-10">
                        <div class="logo-container"><img src="https://img5.pic.in.th/file/secure-sv1/2613be45e1aa0f1e99dd6a6f89e87139.png" class="logo-img"></div>
                        <h1 class="text-2xl font-bold text-gray-800 drop-shadow-sm">วิเคราะห์ธาตุเจ้าเรือน</h1>
                        <p class="text-sm text-yellow-700 mt-1 font-medium">กลุ่มงานการแพทย์แผนไทยฯ รพ.สะเดา</p>
                    </div>

                    <div class="input-group">
                        <span class="input-label">วันที่เกิด</span>
                        <select id="inputDay" class="custom-select"></select>
                    </div>
                    <div class="input-group">
                        <span class="input-label">เดือนเกิด</span>
                        <select id="inputMonth" class="custom-select"></select>
                    </div>
                    <div class="input-group">
                        <span class="input-label">ปี พ.ศ.เกิด</span>
                        <select id="inputYear" class="custom-select"></select>
                    </div>

                    <button onclick="startAnalysis()" class="btn-gold mt-4">
                        <i class="fas fa-search mr-2"></i> วิเคราะห์ธาตุเจ้าเรือน
                    </button>

                    <div class="forecast-box">
                        <div class="forecast-header">
                            <div class="text-sm font-bold text-green-900"><i class="fas fa-calendar-day mr-1"></i> อุตุสมุฏฐานวันนี้</div>
                            <div class="text-xs text-gray-500" id="todayDate">...</div>
                        </div>
                        <span class="utu-badge" id="todaySeason">...</span>
                        <div style="background: rgba(255,235,238,0.8); border: 1px dashed #EF5350; border-radius: 12px; padding: 10px; margin-bottom: 10px; font-size: 12px; color: #C62828;">
                            <i class="fas fa-exclamation-triangle mr-1"></i> <span class="font-bold">กลุ่มเสี่ยงวันนี้:</span> <span id="todayVulnerable">...</span>
                        </div>
                        <p class="text-xs text-gray-600 mb-2" id="todayHealth">...</p>
                    </div>
                </div>
            </div>

            <div id="resultFace" class="card-face card-back">
                <div id="resultHeader" class="back-header">
                    <img id="avatarImg" src="" class="avatar-real hidden">
                    <h2 class="text-2xl font-bold text-white drop-shadow-md" id="resMain">...</h2>
                    <p class="text-white/90 text-xs mt-1 font-light" id="resSub">...</p>
                    <div class="debug-info" id="debugCalc"></div>
                </div>

                <div class="back-content">
                    
                    <div class="section-header">
                        <div class="section-title"><i class="fas fa-user-circle"></i> ลักษณะนิสัย</div>
                        <button class="btn-like" id="likeTrait" onclick="sendFeedback('trait')">
                            <i class="far fa-thumbs-up"></i> ตรงมาก
                        </button>
                    </div>
                    <div class="detail-box" id="resTrait">...</div>

                    <div class="section-header">
                        <div class="section-title" style="color:#C62828;"><i class="fas fa-heartbeat" style="color:#EF5350;"></i> ปัญหาสุขภาพ</div>
                        <button class="btn-like" id="likeHealth" onclick="sendFeedback('health')">
                            <i class="far fa-thumbs-up"></i> ตรงมาก
                        </button>
                    </div>
                    <div class="detail-box" style="background:#FFEBEE; border-left-color:#EF5350;" id="resHealth">...</div>

                    <div class="section-header">
                        <div class="section-title" style="color:#2E7D32;"><i class="fas fa-utensils"></i> อาหารปรับสมดุล</div>
                        <button class="btn-like" id="likeFood" onclick="sendFeedback('food')">
                            <i class="far fa-thumbs-up"></i> ตรงมาก
                        </button>
                    </div>
                    <div class="detail-box" style="background:#E8F5E9; border-left-color:#66BB6A;">
                        <div id="resTasteGood" class="font-bold mb-1 text-green-800"></div>
                        <div id="resTasteGoodReason" class="text-xs text-gray-600 mb-2"></div>
                        <div class="h-px bg-green-200 my-2"></div>
                        <div class="text-xs text-red-500 font-bold mb-1">ควรเลี่ยง:</div>
                        <div id="resTasteBad" class="text-xs text-gray-600"></div>
                    </div>

                    <div class="section-title mt-4"><i class="fas fa-images"></i> เมนูแนะนำ (กดเพื่อดูรูป)</div>
                    <div id="foodList" class="mb-4"></div>
                    <div id="fruitList" class="mb-6"></div>
                </div>

                <div class="p-4 bg-white border-t text-center z-20">
                    <button onclick="resetCard()" class="w-full py-3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition">
                        <i class="fas fa-redo mr-2"></i> วิเคราะห์ใหม่
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & API ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX7ZJvwflkNzhZ1SPPOJZZcJBvh_Bpbc2acOjh6fEcj58fv9wHu4i9M8J5BoCNmIoDbw/exec';
        
        let currentSessionId = "";
        let currentAnalysisData = {};

        // --- 1. CORE LOGIC (Pongsathorn's Algorithm) ---
        class ThaiLunarCalendar {
            constructor(){this.startYData=[[1901,0.122733000004352],[1906,0.0191890000045229],[1911,-0.0843549999953059],[1916,-0.187898999995135],[1921,-0.291442999994964],[1926,0.0744250000052413],[1931,-0.0291189999945876],[1936,-0.132662999994416],[1941,-0.236206999994245],[1946,-0.339750999994074],[1951,-0.443294999993903],[1956,-0.0774269999936981],[1961,-0.180970999993527],[1966,-0.284514999993356],[1971,-0.388058999993185],[1976,-0.491602999993014],[1981,-0.595146999992842],[1986,-0.698690999992671],[1991,-0.332822999992466],[1996,-0.436366999992295],[2001,-0.539910999992124],[2006,-0.643454999991953],[2011,0.253001000008218],[2016,0.149457000008389],[2021,-0.484674999991406],[2026,-0.588218999991235],[2031,0.308237000008937],[2036,0.204693000009108],[2041,0.101149000009279],[2046,-0.00239499999055015],[2051,-0.105938999990379],[2056,0.259929000009826],[2061,0.156385000009997],[2066,0.0528410000101682]];this.sDate=[new Date(1902,10,30),new Date(1912,11,8),new Date(1922,10,19),new Date(1932,10,27),new Date(1942,11,7),new Date(1952,10,16),new Date(1962,10,26),new Date(1972,11,5),new Date(1982,10,15),new Date(1992,10,24),new Date(2002,11,4),new Date(2012,10,13),new Date(2022,10,23),new Date(2032,11,2),new Date(2042,11,12),new Date(2052,10,21),new Date(2062,11,1),new Date(2072,11,9)];}xlMod(a,b){return a-b*Math.floor(a/b)}athikaMas(i){let a=this.xlMod((i-78)-0.45222,2.7118886);return a<1}athikaVar(i){if(this.athikaMas(i))return!1;let c;if(this.athikaMas(i+1))c=0.0169501433191599;else c=-0.0142223099315486;return this.deviation(i)>c}deviation(y){let f=0,fy=0,c=0,l=0;for(let k=0;k<this.startYData.length;k++){if(y>=this.startYData[k][0]){fy=this.startYData[k][0];f=this.startYData[k][1]}else break}if(fy===0)return 0;if(y===fy)c=f;else{fy++;for(let i=fy;i<=y;i++){if(i===fy)l=f;else l=c;if(this.athikaMas(i-1))c=-0.102356;else if(this.athikaVar(i-1))c=-0.632944;else c=0.367056;c=l+c}}return c}lDayInYear(i){if(this.athikaMas(i))return 384;else if(this.athikaVar(i))return 355;else return 354}getThaiLunarDate(d){const y=d.getFullYear();if(y<1903||y>2082)return null;let b;const cy=y-1;const sy=1902;let bk=Math.floor((cy-sy)/10);if(bk<0)bk=0;if(bk>17)bk=17;b=new Date(this.sDate[bk]);let t=new Date(b);for(let i=b.getFullYear()+1;i<=y-1;i++){t.setDate(t.getDate()+this.lDayInYear(i))}b=new Date(t);let ep=new Date(b.getFullYear(),11,31);let rp=Math.round((ep-b)/(86400000));let sc=new Date(y,0,1);let dy=Math.round((d-sc)/(86400000));let df=rp+dy+1;let ny=this.lDayInYear(y);let dof=df,tm,ts;let md=[];if(ny===354)md=[29,30,29,30,29,30,29,30,29,30,29,30,29,30];else if(ny===355)md=[29,30,29,30,29,30,30,30,29,30,29,30,29,30];else if(ny===384)md=[29,30,29,30,29,30,29,30,30,29,30,29,30,29,30];for(let j=0;j<md.length;j++){tm=j+1;if(dof<=md[j]&&dof>0)break;else dof-=md[j]}if(ny===384){if(tm>13)tm-=13;if(tm===9)tm=88;else if(tm>=10)tm=tm-1}else{if(tm>12)tm-=12}if(dof>15){ts="Waning";dof-=15}else{ts="Waxing"}const tn=["๐","๑","๒","๓","๔","๕","๖","๗","๘","๙"];const tt=(n)=>n.toString().split('').map(x=>tn[x]||x).join('');let mdsp=tm;if(tm==88)mdsp="๘๘";else mdsp=tt(tm);return{phase:ts,day:dof,month:tm,year:y,display:`${ts=='Waxing'?'ขึ้น':'แรม'} ${tt(dof)} ค่ำ เดือน ${mdsp}`}}}

        // --- 2. DATA (Sadao Hospital Rules - Fixed Keys) ---
        const baseElementData = {
            earth: {
                name: "ธาตุดิน (ปถวี)",
                trait: "รูปร่างสูงใหญ่ แข็งแรง กระดูกใหญ่ ผมดกดำหนา พูดจาฉะฉาน หนักแน่น สุขุมรอบคอบ จิตใจมั่นคง ดื้อรั้น",
                recTaste: "ฝาด, หวาน, มัน, เค็ม",
                recReason: "บำรุงธาตุดินให้สมบูรณ์ สมานแผลภายใน (ฝาด) ให้กำลัง (หวาน/มัน/เค็ม)",
                badTaste: "มันจัดเกินไป, หวานจัดเกินไป",
                badReason: "ดูดซึมและเผาผลาญยาก ทำให้ธาตุดินกำเริบ (อ้วน/ไขมัน)",
                foods: ["ผักกูด", "แกงเลียง", "แกงจืดเต้าหู้", "มัสมั่น (พอดี)", "พะโล้", "ราดหน้า", "ยำถั่วพู"],
                fruits: ["มังคุด", "ฝรั่งดิบ", "ฟักทอง", "เผือก", "ถั่วต่างๆ", "เงาะ", "น้ำนม", "อ้อย"]
            },
            fire: {
                name: "ธาตุไฟ (เตโช)",
                trait: "รูปร่างสมส่วน ผิวขาวเหลือง พูดชัด เสียงดัง หิวบ่อย กินจุ ขี้หงุดหงิด โกรธง่ายหายเร็ว ผมหงอกก่อนวัย",
                recTaste: "ขม, เย็น, จืด",
                recReason: "ช่วยลดความร้อน ดับพิษร้อนในร่างกาย",
                badTaste: "รสจัด (เผ็ด/เปรี้ยว/เค็ม), ร้อน",
                badReason: "กระตุ้นธาตุไฟให้กำเริบ ทำให้ร้อนใน เป็นไข้ หงุดหงิด",
                foods: ["แกงจืดตำลึง", "ต้มฟัก", "ผัดผักบุ้ง", "แตงกวาผัดไข่", "แกงส้ม (ไม่เผ็ดมาก)", "น้ำพริกหนุ่ม"],
                fruits: ["แตงโม", "แคนตาลูป", "แก้วมังกร", "ชมพู่", "มังคุด", "ส้มโอ"]
            },
            wind: {
                name: "ธาตุลม (วาโย)",
                trait: "ร่างกายผอม ผิวแห้ง ผมบาง พูดเยอะ อารมณ์แปรปรวน ขี้กลัว วิตกกังวล อยากรู้อยากเห็น นอนหลับยาก",
                recTaste: "เผ็ดร้อน, สุขุม",
                recReason: "ช่วยขับลม กระจายเลือดลม แก้ท้องอืดท้องเฟ้อ",
                badTaste: "รสจัดเกินไป, ของหมักดอง",
                badReason: "ทำให้เสมหะเหนียวข้น เลือดลมเดินไม่สะดวก",
                foods: ["ต้มยำ", "ข่าไก่", "แกงป่า", "ผัดกะเพรา", "ไก่ผัดขิง", "น้ำพริกขิง"],
                fruits: ["ส้ม", "เงาะ", "สละ", "ลองกอง", "ลำไย", "น้ำขิง"]
            },
            water: {
                name: "ธาตุน้ำ (อาโป)",
                trait: "รูปร่างอวบ ผิวขาว ตาโต พูดช้าเสียงไพเราะ เคลื่อนไหวช้า ผมละเอียดสวย ดกดำ ชอบนอน ใจเย็น",
                recTaste: "เปรี้ยว, ขม, ร้อน",
                recReason: "ช่วยกัดเสมหะ (เสมหะ) บำรุงโลหิต และขับน้ำส่วนเกิน",
                badTaste: "หวานจัด, เปรี้ยวจัด, เค็มจัด",
                badReason: "ทำให้น้ำเหลืองเสีย เพิ่มเสมหะ และตัวบวมง่าย",
                foods: ["แกงส้มดอกแค", "ต้มยำปลา", "ห่อหมก", "แกงเหลือง", "น้ำพริกมะขาม", "ส้มตำ"],
                fruits: ["สับปะรด", "ส้มโอ", "มะเฟือง", "มะขามป้อม", "ตะลิงปลิง"]
            },
            fire_wind: { 
                name: "ธาตุไฟระคนลม (ช่วงรอยต่อ)",
                trait: "ผสมผสาน: หงุดหงิดง่าย (ไฟ) แต่ขี้กังวล (ลม) พูดเร็ว คิดเร็ว",
                recTaste: "จืด, หอมเย็น, สุขุม",
                recReason: "ดับพิษร้อนและแก้วิงเวียนศีรษะ",
                badTaste: "เผ็ดจัด, ร้อนจัด",
                badReason: "กระตุ้นทั้งลมและไฟให้กำเริบพร้อมกัน",
                foods: ["แกงจืด", "ปลานึ่ง", "ผัดขิง (อ่อนๆ)", "น้ำสมุนไพรฤทธิ์เย็น"],
                fruits: ["แตงโม", "ส้มโอ", "แก้วมังกร"]
            }
        };

        // Complete coverage logic (No gaps)
        const sadaoData = [
            // EARTH
            { check: (m, p) => (m==1 && p=='Waning') || (m==2 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๑ - ขึ้น ๑๕ ค่ำ เดือน ๒", baseElement: "earth", specificHealth: "มีอาการท้องผูก ขับถ่ายลำบาก ปวดท้อง ลมติดในเส้น" },
            { check: (m, p) => (m==2 && p=='Waning') || (m==3 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๒ - ขึ้น ๑๕ ค่ำ เดือน ๓", baseElement: "earth", specificHealth: "มีอาการหายใจไม่สุด หายใจไม่เต็มอิ่ม เหนื่อยง่าย" },
            { check: (m, p) => (m==3 && p=='Waning') || (m==4 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๓ - ขึ้น ๑๕ ค่ำ เดือน ๔", baseElement: "earth", specificHealth: "ถ่ายเหลวได้ง่าย ลำไส้แปรปรวน ปัญหาประจำเดือน ปัญหาระบบปัสสาวะ" },
            // FIRE
            { check: (m, p) => (m==4 && p=='Waning') || (m==5 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๔ - ขึ้น ๑๕ ค่ำ เดือน ๕", baseElement: "fire", specificHealth: "เป็นลม หน้ามืด ไข้แดด ร้อนใน หลับยาก" },
            // Gap Fill: Month 5 Waning - Month 6 Waxing
            { check: (m, p) => (m==5 && p=='Waning') || (m==6 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๕ - ขึ้น ๑๕ ค่ำ เดือน ๖", baseElement: "fire", specificHealth: "เสี่ยงต่อความร้อนภายใน ร้อนใน กระหายน้ำ (ช่วงรอยต่อฤดู)" },
            { check: (m, p) => (m==6 && p=='Waning') || (m==7 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๖ - ขึ้น ๑๕ ค่ำ เดือน ๗", baseElement: "fire", specificHealth: "ความดันโลหิต อารมณ์แปรปรวน นอนหลับยาก ตื่นง่าย" },
            // OVERLAP
            { check: (m, p) => (m==8 && p=='Waning') || (m==9 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๘ - ขึ้น ๑๕ ค่ำ เดือน ๙", baseElement: "fire_wind", specificHealth: "ปวดศีรษะ ปวดกระบอกตา หูอื้อ (ไฟ) และ ท้องอืด แน่นท้อง (ลม)" },
            // WIND
            { check: (m, p) => (m==7 && p=='Waning') || (m==8 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๗ - ขึ้น ๑๕ ค่ำ เดือน ๘", baseElement: "wind", specificHealth: "ไอ ระคายเคืองคอ เจ็บคอ จุกคอ ลมตีขึ้น" },
            { check: (m, p) => (m==9 && p=='Waning') || (m==10 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๙ - ขึ้น ๑๕ ค่ำ เดือน ๑๐", baseElement: "wind", specificHealth: "กรดไหลย้อน ท้องเฟ้อ ท้องบิด แสบร้อนกลางอก อาหารไม่ย่อย" },
            // WATER
            { check: (m, p) => (m==10 && p=='Waning') || (m==11 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๑๐ - ขึ้น ๑๕ ค่ำ เดือน ๑๑", baseElement: "water", specificHealth: "อาการปวดในข้อ ปวดข้อเข่า ปวดกระดูก ริดสีดวง ฝี สิว" },
            { check: (m, p) => (m==11 && p=='Waning') || (m==12 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๑๑ - ขึ้น ๑๕ ค่ำ เดือน ๑๒", baseElement: "water", specificHealth: "ภูมิแพ้ หวัด น้ำมูก กรน หายใจติดขัด แน่นหน้าอก" },
            { check: (m, p) => (m==12 && p=='Waning') || (m==1 && p=='Waxing'), range: "แรม ๑ ค่ำ เดือน ๑๒ - ขึ้น ๑๕ ค่ำ เดือน ๑", baseElement: "water", specificHealth: "ผดผื่น สิว ลมพิษ คันง่าย ภูมิแพ้ผิวหนัง" }
        ];

        const seasonData = {
            summer: { name: "คิมหันตฤดู (ร้อน)", vul: "ธาตุไฟ", health: "เสี่ยงลมแดด ร้อนใน กระหายน้ำ", food: "อาหารรสขม เย็น จืด", theme: "summer", fx: "sun" },
            rain: { name: "วสันตฤดู (ฝน)", vul: "ธาตุลม/ไฟ", health: "ระวังไข้หวัด วิงเวียน ศีรษะ", food: "อาหารรสเปรี้ยว เผ็ดร้อน", theme: "rain", fx: "rain" },
            winter: { name: "เหมันตฤดู (หนาว)", vul: "ธาตุน้ำ/ดิน", health: "ผิวแห้ง ปวดข้อ น้ำมูกไหล", food: "อาหารรสมัน เค็ม ร้อน", theme: "winter", fx: "snow" }
        };

        // --- 3. LOGGING SYSTEM ---
        function generateSessionId() {
            return 'user-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }

        async function logToGoogleSheet(data) {
            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                console.log("Logged:", data);
            } catch (error) {
                console.error("Log Error:", error);
            }
        }

        function sendFeedback(topic) {
            const btn = document.getElementById('like' + topic.charAt(0).toUpperCase() + topic.slice(1));
            if (btn.classList.contains('active')) return;
            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-check"></i> ขอบคุณ';
            logToGoogleSheet({
                type: 'feedback',
                sessionId: currentSessionId,
                timestamp: new Date().toISOString(),
                feedback_topic: topic,
                score: 1,
                ...currentAnalysisData
            });
        }

        // --- 4. APP LOGIC ---
        const calendar = new ThaiLunarCalendar();

        window.onload = function() {
            currentSessionId = generateSessionId();
            const dS = document.getElementById('inputDay'); for(let i=1; i<=31; i++) { let o = document.createElement('option'); o.value=i; o.innerText=i; dS.appendChild(o); }
            const mS = document.getElementById('inputMonth'); const months = ["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"]; months.forEach((m,i)=>{ let o=document.createElement('option'); o.value=i+1; o.innerText=m; mS.appendChild(o); });
            const yS = document.getElementById('inputYear'); const curY = new Date().getFullYear(); for(let i=0; i<100; i++) { let y = curY-i; let o = document.createElement('option'); o.value = y; o.innerText = y+543; yS.appendChild(o); } yS.value = curY-30;
            updateDailyForecast();
        }

        function calculateRealLunarDate(date) { return calendar.getThaiLunarDate(date); }
        function getDailySeason(m) { if (m>=5 && m<=6) return seasonData.summer; if (m>=7 && m<=10) return seasonData.rain; return seasonData.winter; }

        function updateDailyForecast() {
            const today = new Date(); const lunar = calculateRealLunarDate(today); if(!lunar) return;
            let checkM = lunar.month; if(checkM==88) checkM=8;
            const season = getDailySeason(checkM);
            const mTh = ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];
            document.getElementById('todayDate').innerText = `${today.getDate()} ${mTh[today.getMonth()]} ${today.getFullYear()+543}`;
            document.getElementById('todaySeason').innerText = season.name;
            document.getElementById('todayVulnerable').innerText = season.vul;
            document.getElementById('todayHealth').innerText = season.health;
            document.getElementById('todayFood').innerText = `แนะนำ: ${season.food}`;
            const div = document.getElementById('weatherContainer'); div.innerHTML='';
            const front = document.getElementById('cardFront');
            front.classList.remove('theme-winter','theme-summer','theme-rain'); front.classList.add(`theme-${season.theme}`);
            if(season.fx=='rain') { for(let i=0;i<30;i++){ let d=document.createElement('div'); d.className='rain'; d.style.left=Math.random()*100+'%'; d.style.animationDuration=(0.5+Math.random())+'s'; div.appendChild(d); }}
            else if(season.fx=='sun') { let s=document.createElement('div'); s.className='sun-glare'; div.appendChild(s); }
            else { for(let i=0;i<30;i++){ let s=document.createElement('div'); s.className='snowflake'; s.style.left=Math.random()*100+'%'; s.style.animationDuration=(3+Math.random()*2)+'s'; div.appendChild(s); }}
        }

        function createFoodTags(items, id) {
            const c = document.getElementById(id); c.innerHTML='';
            items.forEach(i => {
                let a = document.createElement('a'); a.className='food-tag';
                a.innerHTML = `${i} <i class="fas fa-search text-xs ml-1 text-gray-400"></i>`;
                a.href = `https://www.google.com/search?tbm=isch&q=${i} อาหาร`; a.target = '_blank'; c.appendChild(a);
            });
        }

        async function startAnalysis() {
            document.getElementById('loading').style.display = 'flex';
            setTimeout(async () => {
                const d = parseInt(document.getElementById('inputDay').value);
                const m = parseInt(document.getElementById('inputMonth').value);
                const y = parseInt(document.getElementById('inputYear').value);
                let birthDate = new Date(y, m-1, d);
                let conceptionDate = new Date(birthDate); conceptionDate.setMonth(birthDate.getMonth()-9);
                const lunar = calculateRealLunarDate(conceptionDate);
                
                if (!lunar) { alert("ปีที่ระบุอยู่นอกช่วงการคำนวณ (2446-2599)"); document.getElementById('loading').style.display = 'none'; return; }

                let checkMonth = lunar.month; if (checkMonth == 88) checkMonth = 8;
                let key = "earth"; let specificHealth = ""; let range = ""; let matched = false;

                for (let rule of sadaoData) {
                    if (rule.check(checkMonth, lunar.phase)) {
                        key = rule.baseElement; specificHealth = rule.specificHealth; range = rule.range; matched = true; break;
                    }
                }
                
                if(!matched) {
                    if(checkMonth >= 1 && checkMonth <= 4) { key="earth"; specificHealth="ท้องผูกง่าย อาหารไม่ย่อย"; }
                    else if(checkMonth >= 5 && checkMonth <= 7) { key="fire"; specificHealth="ร้อนใน กระหายน้ำ"; }
                    else if(checkMonth >= 8 && checkMonth <= 10) { key="wind"; specificHealth="ท้องอืด วิงเวียน"; }
                    else { key="water"; specificHealth="ภูมิแพ้ เสมหะ"; }
                }

                const data = baseElementData[key];
                let color="", avatar="";
                if(key.includes("fire")) { color="linear-gradient(135deg, #FF9966, #FF5E62)"; avatar="https://img5.pic.in.th/file/secure-sv1/41a8f63dde1ba7c4b.png"; }
                else if(key.includes("wind")) { color="linear-gradient(135deg, #56ab2f, #a8e063)"; avatar="https://img2.pic.in.th/261c90e765ec6b116.png"; }
                else if(key.includes("water")) { color="linear-gradient(135deg, #36D1DC, #5B86E5)"; avatar="https://img5.pic.in.th/file/secure-sv1/3141eb0166e3e7f51.png"; }
                else { color="linear-gradient(135deg, #CAC531, #F3F9A7)"; avatar="https://img2.pic.in.th/1c8b450894dd6fe8e.png"; }

                document.getElementById('resMain').innerText = data.name;
                document.getElementById('resSub').innerText = range; 
                document.getElementById('debugCalc').innerText = `(ปฏิสนธิ: ${lunar.display})`;
                document.getElementById('avatarImg').src = avatar;
                document.getElementById('avatarImg').classList.remove('hidden');
                document.getElementById('resultHeader').style.background = color;
                document.getElementById('resTrait').innerText = data.trait;
                document.getElementById('resHealth').innerText = specificHealth; 
                document.getElementById('resTasteGood').innerText = data.recTaste;
                document.getElementById('resTasteGoodReason').innerText = data.recReason;
                
                // Fixed: Correctly display Bad Taste Reason
                const badContainer = document.getElementById('resTasteBad');
                badContainer.innerHTML = `<span class="font-bold text-red-800">${data.badTaste}</span><br>${data.badReason}`;

                createFoodTags(data.foods, 'foodList');
                createFoodTags(data.fruits, 'fruitList');

                // Reset Like Buttons
                ['likeTrait','likeHealth','likeFood'].forEach(id => {
                    const b = document.getElementById(id); b.classList.remove('active'); b.innerHTML = '<i class="far fa-thumbs-up"></i> ตรงมาก';
                });

                document.getElementById('cardObject').classList.add('is-flipped');
                document.getElementById('loading').style.display = 'none';

                currentAnalysisData = { birthDate: `${d}/${m}/${y+543}`, conceptionDate: lunar.display, element: data.name, healthProblem: specificHealth };
                logToGoogleSheet({ type: 'analysis', sessionId: currentSessionId, timestamp: new Date().toISOString(), ...currentAnalysisData });

            }, 500);
        }

        function resetCard() { document.getElementById('cardObject').classList.remove('is-flipped'); }
    </script>
</body>
</html>
