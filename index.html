<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>วิเคราะห์ธาตุเจ้าเรือน (Sadao Official)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold-main: #D4AF37; --green-deep: #1B4D3E; }
        body { font-family: 'Prompt', sans-serif; background-color: #FDFBF7; color: #333; overflow-x: hidden; }
        
        /* 3D Card */
        .card-scene { width: 100%; max-width: 450px; margin: 0 auto; min-height: 100vh; perspective: 1500px; padding: 40px 20px; }
        .card-object { width: 100%; position: relative; transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .card-face { width: 100%; border-radius: 30px; backface-visibility: hidden; background: white; box-shadow: 0 20px 50px rgba(0,0,0,0.15); min-height: 850px; display: flex; flex-direction: column; overflow: hidden; }
        .card-front { transform: rotateY(0deg); position: relative; background: linear-gradient(to bottom, #ffffff, #f9f9f9); }
        .card-back { position: absolute; top: 0; left: 0; height: 100%; transform: rotateY(180deg); }
        .is-flipped { transform: rotateY(180deg); }

        /* Weather BG */
        .weather-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.6; }
        .theme-winter { background: linear-gradient(to bottom, #90CAF9 0%, #E3F2FD 100%) !important; }
        .theme-summer { background: linear-gradient(to bottom, #FFCC80 0%, #FFF3E0 100%) !important; }
        .theme-rain { background: linear-gradient(to bottom, #B0BEC5 0%, #ECEFF1 100%) !important; }
        
        .snowflake { position: absolute; width: 5px; height: 5px; background: #fff; border-radius: 50%; animation: snow-fall linear infinite; box-shadow: 0 0 4px rgba(255,255,255,0.8); }
        @keyframes snow-fall { 0% { transform: translateY(-10px) translateX(0); opacity: 0; } 100% { transform: translateY(900px) translateX(20px); opacity: 0; } }
        .rain { background: linear-gradient(to bottom, rgba(0,0,255,0) 0%, rgba(255,255,255,0.8) 100%); height: 40px; position: absolute; width: 2px; animation: rain-fall 0.7s linear infinite; }
        @keyframes rain-fall { 0% { transform: translateY(-100px); } 100% { transform: translateY(900px); } }
        .sun-glare { position: absolute; top: -80px; right: -80px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,200,0.6) 0%, rgba(255,255,255,0) 70%); animation: sun-pulse 5s ease-in-out infinite; }
        @keyframes sun-pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }

        /* Logo Animation */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .logo-container { width: 100px; height: 100px; margin: 0 auto 20px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid var(--gold-main); animation: float 4s ease-in-out infinite; box-shadow: 0 10px 20px rgba(212,175,55,0.2); }
        .logo-img { width: 90%; }

        /* Inputs */
        .input-group { position: relative; margin-bottom: 25px; z-index: 20; }
        .input-label { position: absolute; top: -10px; left: 15px; background: white; padding: 0 8px; color: var(--green-deep); font-size: 13px; font-weight: bold; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 30; }
        .custom-select { width: 100%; padding: 16px; border: 1.5px solid rgba(27,77,62,0.3); border-radius: 16px; font-family: 'Prompt'; background: rgba(255,255,255,0.95); outline: none; appearance: none; pointer-events: auto; }
        
        .btn-gold { background: linear-gradient(135deg, var(--green-deep), #2E7D32); color: white; padding: 16px; width: 100%; border-radius: 16px; font-weight: bold; box-shadow: 0 10px 20px rgba(27,77,62,0.3); cursor: pointer; position: relative; z-index: 20; }

        /* Forecast Box */
        .forecast-box { margin-top: auto; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; border: 1px solid white; box-shadow: 0 15px 35px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        .utu-badge { background: var(--green-deep); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 8px; }
        .vulnerable-box { background: rgba(255,235,238,0.95); border: 1px dashed #EF5350; border-radius: 10px; padding: 10px; margin-bottom: 10px; font-size: 12px; color: #C62828; display: flex; align-items: center; }

        /* Results */
        .back-header { padding: 50px 20px 40px; text-align: center; color: white; border-radius: 0 0 40% 40% / 0 0 30px 30px; position: relative; flex-shrink: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .avatar-real { width: 150px; height: 150px; margin: -5px auto 10px; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2)); border-radius: 50%; background: white; border: 4px solid rgba(255,255,255,0.4); }
        .back-content { flex-grow: 1; overflow-y: auto; padding: 20px; margin-top: -30px; z-index: 10; -webkit-overflow-scrolling: touch; }
        
        .section-title { font-size: 15px; font-weight: bold; color: var(--green-deep); margin-bottom: 12px; display: flex; align-items: center; background: linear-gradient(to right, rgba(255,255,255,0.95), rgba(255,255,255,0.7)); padding: 8px 12px; border-radius: 10px; border-left: 4px solid var(--gold-main); box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .detail-box { background: #FAFAFA; border-radius: 16px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.03); font-size: 13px; color: #555; line-height: 1.7; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .food-tag { display: inline-block; padding: 8px 14px; margin: 0 6px 8px 0; background: white; border: 1px solid #E0E0E0; border-radius: 25px; font-size: 12px; color: #333; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
        .debug-info { font-size: 10px; color: rgba(255,255,255,0.6); margin-top: 5px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">

    <div class="card-scene">
        <div id="cardObject" class="card-object">
            
            <div id="cardFront" class="card-face card-front">
                <div id="weatherContainer" class="weather-container"></div>
                <div style="padding: 50px 30px 30px; position: relative; z-index: 10; display: flex; flex-direction: column; height: 100%;">
                    
                    <div class="text-center mb-6">
                        <div class="logo-container"><img src="https://img5.pic.in.th/file/secure-sv1/2613be45e1aa0f1e99dd6a6f89e87139.png" class="logo-img"></div>
                        <h1 class="text-2xl font-bold">วิเคราะห์ธาตุเจ้าเรือน</h1>
                        <p class="text-sm text-yellow-700 mt-1">กลุ่มงานการแพทย์แผนไทยฯ รพ.สะเดา</p>
                    </div>

                    <div class="input-group">
                        <span class="input-label">วันที่เกิด</span>
                        <select id="inputDay" class="custom-select"></select>
                    </div>
                    <div class="input-group">
                        <span class="input-label">เดือนเกิด</span>
                        <select id="inputMonth" class="custom-select"></select>
                    </div>
                    <div class="input-group">
                        <span class="input-label">ปี พ.ศ.เกิด</span>
                        <select id="inputYear" class="custom-select"></select>
                    </div>

                    <button onclick="startAnalysis()" class="btn-gold mt-4">
                        <span>วิเคราะห์</span> <i class="fas fa-search ml-2"></i>
                    </button>

                    <div class="forecast-box">
                        <div class="flex justify-between items-center mb-2 border-b pb-2 border-gray-100">
                            <span class="text-sm font-bold text-green-900"><i class="fas fa-calendar-day mr-1"></i> อุตุสมุฏฐานวันนี้</span>
                            <span class="text-xs text-gray-500" id="todayDate">...</span>
                        </div>
                        <span class="utu-badge" id="todaySeason">...</span>
                        <div class="vulnerable-box">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <div><span class="font-bold">กลุ่มเสี่ยงวันนี้:</span> <span id="todayVulnerable">...</span></div>
                        </div>
                        <p class="text-xs text-gray-600 mb-2" id="todayHealth">...</p>
                        <div class="food-advice">
                            <i class="fas fa-utensils text-green-600 mr-2 mt-1"></i> 
                            <span id="todayFood">...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="resultFace" class="card-face card-back">
                <div id="resultHeader" class="back-header">
                    <img id="avatarImg" src="" class="avatar-real hidden">
                    <h2 class="text-2xl font-bold text-white drop-shadow-md" id="resMain">...</h2>
                    <p class="text-white/90 text-xs mt-1" id="resSub">...</p>
                    <div class="debug-info" id="debugCalc"></div>
                </div>

                <div class="back-content">
                    <div class="section-title"><i class="fas fa-user-circle"></i> ลักษณะนิสัย</div>
                    <div class="detail-box" id="resTrait">...</div>

                    <div class="section-title" style="color:#C62828; border-color:#EF5350;"><i class="fas fa-heartbeat text-red-500"></i> ปัญหาสุขภาพ</div>
                    <div class="detail-box" style="background:#FFEBEE; border-color:#EF5350;" id="resHealth">...</div>

                    <div class="section-title"><i class="fas fa-thumbs-up text-green-600"></i> อาหารที่แนะนำ</div>
                    <div class="detail-box" style="background:#E8F5E9; border-color:#66BB6A;">
                        <div id="resTasteGood" class="font-bold mb-1 text-green-800"></div>
                        <div id="resTasteGoodReason" class="text-xs text-gray-600"></div>
                    </div>

                    <div class="section-title"><i class="fas fa-thumbs-down text-red-500"></i> อาหารที่ควรเลี่ยง</div>
                    <div class="detail-box" style="background:#FBE9E7; border-color:#FF7043;">
                        <div id="resTasteBad" class="font-bold mb-1 text-red-800"></div>
                        <div id="resTasteBadReason" class="text-xs text-gray-600"></div>
                    </div>

                    <div class="section-title"><i class="fas fa-utensils"></i> เมนูแนะนำ</div>
                    <div id="foodList" class="mb-4"></div>
                    
                    <div class="section-title"><i class="fas fa-lemon"></i> ผลไม้</div>
                    <div id="fruitList" class="mb-6"></div>
                </div>

                <div class="p-4 bg-white border-t text-center">
                    <button onclick="resetCard()" class="w-full py-3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition">
                        <i class="fas fa-redo mr-1"></i> วิเคราะห์ใหม่
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Thai Lunar Calendar Class (Pongsathorn's Algorithm) ---
        class ThaiLunarCalendar {
            constructor() {
                this.startYData = [
                    [1901, 0.122733000004352], [1906, 1.91890000045229E-02], [1911, -8.43549999953059E-02], [1916, -0.187898999995135], [1921, -0.291442999994964],
                    [1926, 7.44250000052413E-02], [1931, -2.91189999945876E-02], [1936, -0.132662999994416], [1941, -0.236206999994245], [1946, -0.339750999994074],
                    [1951, -0.443294999993903], [1956, -7.74269999936981E-02], [1961, -0.180970999993527], [1966, -0.284514999993356], [1971, -0.388058999993185],
                    [1976, -0.491602999993014], [1981, -0.595146999992842], [1986, -0.698690999992671], [1991, -0.332822999992466], [1996, -0.436366999992295],
                    [2001, -0.539910999992124], [2006, -0.643454999991953], [2011, 0.253001000008218], [2016, 0.149457000008389], [2021, -0.484674999991406],
                    [2026, -0.588218999991235], [2031, 0.308237000008937], [2036, 0.204693000009108], [2041, 0.101149000009279], [2046, -2.39499999055015E-03],
                    [2051, -0.105938999990379], [2056, 0.259929000009826], [2061, 0.156385000009997], [2066, 5.28410000101682E-02], [2071, -5.07029999896607E-02],
                    [2076, -0.15424699998949], [2081, -0.257790999989318], [2086, 0.108077000010887], [2091, 4.53300001105772E-03], [2096, -9.90109999887712E-02],
                    [2101, -0.2025549999886], [2106, -0.306098999988429], [2111, -0.409642999988258], [2116, -4.37749999880528E-02], [2121, -0.147318999987882],
                    [2126, -0.250862999987711], [2131, -0.354406999987539], [2136, -0.457950999987368], [2141, -0.561494999987197], [2146, -0.665038999987026],
                    [2151, -0.299170999986821], [2156, -0.40271499998665], [2161, -0.506258999986479], [2166, -0.609802999986308], [2171, -0.713346999986137],
                    [2176, 0.183109000014035], [2181, -0.45102299998576], [2186, -0.554566999985589], [2191, 0.341889000014582], [2196, 0.238345000014753],
                    [2201, 0.134801000014924], [2206, 3.12570000150951E-02], [2211, -7.22869999847338E-02], [2216, 0.293581000015471], [2221, 0.190037000015642],
                    [2226, 8.64930000158135E-02], [2231, -1.70509999840154E-02], [2236, -0.120594999983844], [2241, -0.224138999983673], [2246, 0.141729000016532],
                    [2251, 0.038185000016703], [2256, -6.53589999831259E-02], [2261, -0.168902999982955], [2266, -0.272446999982784], [2271, -0.375990999982613],
                    [2276, -1.01229999824075E-02], [2281, -0.113666999982236], [2286, -0.217210999982065], [2291, -0.320754999981894], [2296, -0.424298999981723],
                    [2301, -0.527842999981552], [2306, -0.631386999981381], [2311, -0.265518999981176], [2316, -0.369062999981005], [2321, -0.472606999980834],
                    [2326, -0.576150999980662], [2331, -0.679694999980491], [2336, 0.21676100001968], [2341, -0.417370999980115], [2346, -0.520914999979944],
                    [2351, -0.624458999979773], [2356, 0.271997000020398], [2361, 0.168453000020569], [2366, 6.49090000207404E-02], [2371, -3.86349999790885E-02],
                    [2376, 0.327233000021117], [2381, 0.223689000021288], [2386, 0.120145000021459], [2391, 1.66010000216299E-02], [2396, -0.086942999978199],
                    [2401, -0.190486999978028], [2406, 0.175381000022177], [2411, 7.18370000223483E-02], [2416, -3.17069999774806E-02], [2421, -0.135250999977309],
                    [2426, -0.238794999977138], [2431, -0.342338999976967], [2436, 2.35290000232378E-02], [2441, -8.00149999765911E-02], [2446, -0.18355899997642],
                    [2451, -0.287102999976249], [2456, -0.390646999976078]
                ];
                this.sDate = [
                    new Date(1902, 10, 30), new Date(1912, 11, 8), new Date(1922, 10, 19), new Date(1932, 10, 27), new Date(1942, 11, 7),
                    new Date(1952, 10, 16), new Date(1962, 10, 26), new Date(1972, 11, 5), new Date(1982, 10, 15), new Date(1992, 10, 24),
                    new Date(2002, 11, 4), new Date(2012, 10, 13), new Date(2022, 10, 23), new Date(2032, 11, 2), new Date(2042, 11, 12),
                    new Date(2052, 10, 21), new Date(2062, 11, 1), new Date(2072, 11, 9), new Date(2082, 10, 20), new Date(2092, 10, 28),
                    new Date(2102, 11, 9), new Date(2112, 10, 18), new Date(2122, 10, 28), new Date(2132, 11, 7), new Date(2142, 10, 17),
                    new Date(2152, 10, 26), new Date(2162, 11, 6), new Date(2172, 10, 15), new Date(2182, 10, 25), new Date(2192, 11, 4),
                    new Date(2202, 11, 15), new Date(2212, 10, 24), new Date(2222, 11, 4), new Date(2232, 11, 12), new Date(2242, 10, 23),
                    new Date(2252, 11, 1), new Date(2262, 11, 11), new Date(2272, 10, 20), new Date(2282, 10, 30), new Date(2292, 11, 9),
                    new Date(2302, 10, 20), new Date(2312, 10, 29), new Date(2322, 11, 9), new Date(2332, 10, 18), new Date(2342, 10, 28),
                    new Date(2352, 11, 7), new Date(2362, 11, 17), new Date(2372, 10, 26), new Date(2382, 11, 6), new Date(2392, 11, 14),
                    new Date(2402, 10, 25), new Date(2412, 11, 3), new Date(2422, 11, 13), new Date(2432, 10, 23), new Date(2442, 11, 2),
                    new Date(2452, 11, 11)
                ];
            }
            xlMod(a, b) { return a - b * Math.floor(a / b); }
            athikaMas(iYear) { let athi = this.xlMod((iYear - 78) - 0.45222, 2.7118886); return athi < 1; }
            athikaVar(iYear) {
                let cutOff;
                if (this.athikaMas(iYear)) return false;
                else {
                    if (this.athikaMas(iYear + 1)) cutOff = 1.69501433191599E-02;
                    else cutOff = -1.42223099315486E-02;
                    return this.deviation(iYear) > cutOff;
                }
            }
            deviation(iYear) {
                let fDev = 0, fYear = 0, currDev = 0, lastDev = 0;
                for (let k = 0; k < this.startYData.length; k++) {
                    if (iYear >= this.startYData[k][0]) { fYear = this.startYData[k][0]; fDev = this.startYData[k][1]; } else break;
                }
                if (fYear === 0) return 0;
                if (iYear === fYear) currDev = fDev;
                else {
                    fYear = fYear + 1;
                    for (let i = fYear; i <= iYear; i++) {
                        if (i === fYear) lastDev = fDev; else lastDev = currDev;
                        if (this.athikaMas(i - 1)) currDev = -0.102356;
                        else if (this.athikaVar(i - 1)) currDev = -0.632944;
                        else currDev = 0.367056;
                        currDev = lastDev + currDev;
                    }
                }
                return currDev;
            }
            lDayInYear(iYear) {
                if (this.athikaMas(iYear)) return 384;
                else if (this.athikaVar(iYear)) return 355;
                else return 354;
            }
            getThaiLunarDate(iDate) {
                const year = iDate.getFullYear();
                if (year < 1903 || year > 2460) return null;
                let beginDate;
                const cYear = year - 1;
                const startYearBase = 1902;
                let block = Math.floor((cYear - startYearBase) / 10);
                if (block < 0) block = 0; if (block > 55) block = 55;
                beginDate = new Date(this.sDate[block]); 
                let tempDate = new Date(beginDate);
                for (let i = beginDate.getFullYear() + 1; i <= year - 1; i++) {
                    let dayInYear = this.lDayInYear(i);
                    tempDate.setDate(tempDate.getDate() + dayInYear);
                }
                beginDate = new Date(tempDate);
                let endOfPrevYear = new Date(beginDate.getFullYear(), 11, 31);
                let rDayPrev = Math.round((endOfPrevYear - beginDate) / (1000 * 60 * 60 * 24));
                let startOfCurrentYear = new Date(year, 0, 1);
                let dayOfYear = Math.round((iDate - startOfCurrentYear) / (1000 * 60 * 60 * 24));
                let dayFromOne = rDayPrev + dayOfYear + 1;
                let nbLDayYear = this.lDayInYear(year);
                let dofY = dayFromOne, thM, thS;
                let monthDays = [];
                if (nbLDayYear === 354) monthDays = [29, 30, 29, 30, 29, 30, 29, 30, 29, 30, 29, 30, 29, 30]; 
                else if (nbLDayYear === 355) monthDays = [29, 30, 29, 30, 29, 30, 30, 30, 29, 30, 29, 30, 29, 30]; 
                else if (nbLDayYear === 384) monthDays = [29, 30, 29, 30, 29, 30, 29, 30, 30, 29, 30, 29, 30, 29, 30];
                for (let j = 0; j < monthDays.length; j++) {
                    thM = j + 1;
                    if (dofY <= monthDays[j] && dofY > 0) break;
                    else dofY -= monthDays[j];
                }
                if (nbLDayYear === 384) {
                     if (thM > 13) thM -= 13;
                     if (thM === 9) thM = 88; else if (thM >= 10) thM = thM - 1;
                } else {
                    if (thM > 12) thM -= 12;
                }
                if (dofY > 15) { thS = "Waning"; dofY -= 15; } else { thS = "Waxing"; }
                const tNum = ["๐", "๑", "๒", "๓", "๔", "๕", "๖", "๗", "๘", "๙"];
                const toT = (n) => n.toString().split('').map(x => tNum[x] || x).join('');
                let mDisplay = thM;
                if(thM == 88) mDisplay = "๘๘";
                else mDisplay = toT(thM);
                
                return { phase: thS, day: dofY, month: thM, year: year, display: `${thS=='Waxing'?'ขึ้น':'แรม'} ${toT(dofY)} ค่ำ เดือน ${mDisplay}` };
            }
        }

        // --- 2. Data from PDF ---
        const baseElementData = {
            earth: {
                name: "ธาตุดิน (ปถวี)",
                trait: "รูปร่างสูงใหญ่ แข็งแรง กระดูกใหญ่ ผมดกดำหนา พูดจาฉะฉาน หนักแน่น สุขุมรอบคอบ จิตใจมั่นคง ดื้อรั้น",
                recTaste: "ฝาด, หวาน, มัน, เค็ม",
                recReason: "บำรุงธาตุดินให้สมบูรณ์ สมานแผลภายใน (ฝาด) ให้กำลัง (หวาน/มัน/เค็ม)",
                badTaste: "มันจัดเกินไป, หวานจัดเกินไป",
                badReason: "ดูดซึมและเผาผลาญยาก ทำให้ธาตุดินกำเริบ (อ้วน/ไขมัน)",
                foods: ["ผักกูด", "แกงเลียง", "แกงจืดเต้าหู้", "มัสมั่น (พอดี)", "พะโล้", "ราดหน้า", "ยำถั่วพู"],
                fruits: ["มังคุด", "ฝรั่งดิบ", "ฟักทอง", "เผือก", "ถั่วต่างๆ", "เงาะ", "น้ำนม", "อ้อย"]
            },
            fire: {
                name: "ธาตุไฟ (เตโช)",
                trait: "รูปร่างสมส่วน ผิวขาวเหลือง พูดชัด เสียงดัง หิวบ่อย กินจุ ขี้หงุดหงิด โกรธง่ายหายเร็ว ผมหงอกก่อนวัย",
                recTaste: "ขม, เย็น, จืด",
                recReason: "ช่วยลดความร้อน ดับพิษร้อนในร่างกาย",
                badTaste: "รสจัด (เผ็ด/เปรี้ยว/เค็ม), ร้อน",
                badReason: "กระตุ้นธาตุไฟให้กำเริบ ทำให้ร้อนใน เป็นไข้ หงุดหงิด",
                foods: ["แกงจืดตำลึง", "ต้มฟัก", "ผัดผักบุ้ง", "แตงกวาผัดไข่", "แกงส้ม (ไม่เผ็ดมาก)", "น้ำพริกหนุ่ม"],
                fruits: ["แตงโม", "แคนตาลูป", "แก้วมังกร", "ชมพู่", "มังคุด", "ส้มโอ"]
            },
            wind: {
                name: "ธาตุลม (วาโย)",
                trait: "ร่างกายผอม ผิวแห้ง ผมบาง พูดเยอะ อารมณ์แปรปรวน ขี้กลัว วิตกกังวล อยากรู้อยากเห็น นอนหลับยาก",
                recTaste: "เผ็ดร้อน, สุขุม",
                recReason: "ช่วยขับลม กระจายเลือดลม แก้ท้องอืดท้องเฟ้อ",
                badTaste: "รสจัดเกินไป, ของหมักดอง",
                badReason: "ทำให้เสมหะเหนียวข้น เลือดลมเดินไม่สะดวก",
                foods: ["ต้มยำ", "ข่าไก่", "แกงป่า", "ผัดกะเพรา", "ไก่ผัดขิง", "น้ำพริกขิง"],
                fruits: ["ส้ม", "เงาะ", "สละ", "ลองกอง", "ลำไย", "น้ำขิง"]
            },
            water: {
                name: "ธาตุน้ำ (อาโป)",
                trait: "รูปร่างอวบ ผิวขาว ตาโต พูดช้าเสียงไพเราะ เคลื่อนไหวช้า ผมละเอียดสวย ดกดำ ชอบนอน ใจเย็น",
                recTaste: "เปรี้ยว, ขม, ร้อน",
                recReason: "ช่วยกัดเสมหะ (เสมหะ) บำรุงโลหิต และขับน้ำส่วนเกิน",
                badTaste: "หวานจัด, เปรี้ยวจัด, เค็มจัด",
                badReason: "ทำให้น้ำเหลืองเสีย เพิ่มเสมหะ และตัวบวมง่าย",
                foods: ["แกงส้มดอกแค", "ต้มยำปลา", "ห่อหมก", "แกงเหลือง", "น้ำพริกมะขาม", "ส้มตำ"],
                fruits: ["สับปะรด", "ส้มโอ", "มะเฟือง", "มะขามป้อม", "ตะลิงปลิง"]
            },
            fire_wind: { // Mixed for Month 8-9
                name: "ธาตุไฟระคนลม (ช่วงรอยต่อ)",
                trait: "ผสมผสาน: หงุดหงิดง่าย (ไฟ) แต่ขี้กังวล (ลม) พูดเร็ว คิดเร็ว",
                recTaste: "จืด, หอมเย็น, สุขุม",
                recReason: "ดับพิษร้อนและแก้วิงเวียนศีรษะ",
                badTaste: "เผ็ดจัด, ร้อนจัด",
                badReason: "กระตุ้นทั้งลมและไฟให้กำเริบพร้อมกัน",
                foods: ["แกงจืด", "ปลานึ่ง", "ผัดขิง (อ่อนๆ)", "น้ำสมุนไพรฤทธิ์เย็น"],
                fruits: ["แตงโม", "ส้มโอ", "แก้วมังกร"]
            }
        };

        const sadaoData = [
            // EARTH (Din)
            { 
                check: (m, p) => (m==1 && p=='Waning') || (m==2 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๑ - ขึ้น ๑๕ ค่ำ เดือน ๒", baseElement: "earth",
                specificHealth: "มีอาการท้องผูก ขับถ่ายลำบาก ปวดท้อง ลมติดในเส้น"
            },
            {
                check: (m, p) => (m==2 && p=='Waning') || (m==3 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๒ - ขึ้น ๑๕ ค่ำ เดือน ๓", baseElement: "earth",
                specificHealth: "มีอาการหายใจไม่สุด หายใจไม่เต็มอิ่ม เหนื่อยง่าย"
            },
            {
                check: (m, p) => (m==3 && p=='Waning') || (m==4 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๓ - ขึ้น ๑๕ ค่ำ เดือน ๔", baseElement: "earth",
                specificHealth: "ถ่ายเหลวได้ง่าย ลำไส้แปรปรวน ปัญหาประจำเดือน ปัญหาระบบปัสสาวะ"
            },
            // FIRE (Fai)
            {
                check: (m, p) => (m==4 && p=='Waning') || (m==5 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๔ - ขึ้น ๑๕ ค่ำ เดือน ๕", baseElement: "fire",
                specificHealth: "เป็นลม หน้ามืด ไข้แดด ร้อนใน หลับยาก"
            },
            {
                check: (m, p) => (m==6 && p=='Waning') || (m==7 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๖ - ขึ้น ๑๕ ค่ำ เดือน ๗", baseElement: "fire",
                specificHealth: "ความดันโลหิต อารมณ์แปรปรวน นอนหลับยาก ตื่นง่าย"
            },
            // FIRE/WIND Overlap (8-9)
            {
                check: (m, p) => (m==8 && p=='Waning') || (m==9 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๘ - ขึ้น ๑๕ ค่ำ เดือน ๙", baseElement: "fire_wind",
                specificHealth: "ปวดศีรษะ ปวดกระบอกตา หูอื้อ (ไฟ) และ ท้องอืด แน่นท้อง (ลม)"
            },
            // WIND (Lom)
            {
                check: (m, p) => (m==7 && p=='Waning') || (m==8 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๗ - ขึ้น ๑๕ ค่ำ เดือน ๘", baseElement: "wind",
                specificHealth: "ไอ ระคายเคืองคอ เจ็บคอ จุกคอ ลมตีขึ้น"
            },
            {
                check: (m, p) => (m==9 && p=='Waning') || (m==10 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๙ - ขึ้น ๑๕ ค่ำ เดือน ๑๐", baseElement: "wind",
                specificHealth: "กรดไหลย้อน ท้องเฟ้อ ท้องบิด แสบร้อนกลางอก อาหารไม่ย่อย"
            },
            // WATER (Nam)
            {
                check: (m, p) => (m==10 && p=='Waning') || (m==11 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๑๐ - ขึ้น ๑๕ ค่ำ เดือน ๑๑", baseElement: "water",
                specificHealth: "อาการปวดในข้อ ปวดข้อเข่า ปวดกระดูก ริดสีดวง ฝี สิว"
            },
            {
                check: (m, p) => (m==11 && p=='Waning') || (m==12 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๑๑ - ขึ้น ๑๕ ค่ำ เดือน ๑๒", baseElement: "water",
                specificHealth: "ภูมิแพ้ หวัด น้ำมูก กรน หายใจติดขัด แน่นหน้าอก"
            },
            {
                check: (m, p) => (m==12 && p=='Waning') || (m==1 && p=='Waxing'),
                range: "แรม ๑ ค่ำ เดือน ๑๒ - ขึ้น ๑๕ ค่ำ เดือน ๑", baseElement: "water",
                specificHealth: "ผดผื่น สิว ลมพิษ คันง่าย ภูมิแพ้ผิวหนัง"
            }
        ];

        const seasonData = {
            summer: { name: "คิมหันตฤดู (ร้อน)", vul: "ธาตุไฟ", health: "เสี่ยงลมแดด ร้อนใน กระหายน้ำ", food: "อาหารรสขม เย็น จืด", theme: "summer", fx: "sun" },
            rain: { name: "วสันตฤดู (ฝน)", vul: "ธาตุลม/ไฟ", health: "ระวังไข้หวัด วิงเวียน ศีรษะ", food: "อาหารรสเปรี้ยว เผ็ดร้อน", theme: "rain", fx: "rain" },
            winter: { name: "เหมันตฤดู (หนาว)", vul: "ธาตุน้ำ/ดิน", health: "ผิวแห้ง ปวดข้อ น้ำมูกไหล", food: "อาหารรสมัน เค็ม ร้อน", theme: "winter", fx: "snow" }
        };

        // --- 3. App Logic ---
        window.onload = function() {
            const dS = document.getElementById('inputDay'); 
            for(let i=1; i<=31; i++) { let o = document.createElement('option'); o.value=i; o.innerText=i; dS.appendChild(o); }
            
            const mS = document.getElementById('inputMonth');
            const months = ["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];
            months.forEach((m,i)=>{ let o=document.createElement('option'); o.value=i+1; o.innerText=m; mS.appendChild(o); });

            const yS = document.getElementById('inputYear'); 
            const curY = new Date().getFullYear(); 
            for(let i=0; i<100; i++) { 
                let y = curY-i; 
                let o = document.createElement('option'); 
                o.value = y; // AD Value
                o.innerText = y+543; // BE Display
                yS.appendChild(o); 
            }
            yS.value = curY-30;
            updateDailyForecast();
        }

        // Calculate a more precise moon phase for daily forecast
        // Note: The main logic uses the ThaiLunarCalendar class for precision
        const calendar = new ThaiLunarCalendar();

        function getDailySeason(m) {
            if (m>=5 && m<=6) return seasonData.summer;
            if (m>=7 && m<=10) return seasonData.rain;
            return seasonData.winter;
        }

        function updateDailyForecast() {
            const today = new Date();
            const lunar = calendar.getThaiLunarDate(today);
            if(!lunar) return;

            // Handle Adhikamas display month for season check
            let checkMonth = lunar.month;
            if (checkMonth == 88) checkMonth = 8;

            const season = getDailySeason(checkMonth);
            
            const mTh = ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];
            document.getElementById('todayDate').innerText = `${today.getDate()} ${mTh[today.getMonth()]} ${today.getFullYear()+543}`;
            document.getElementById('todaySeason').innerText = season.name;
            document.getElementById('todayVulnerable').innerText = season.vul;
            document.getElementById('todayHealth').innerText = season.health;
            document.getElementById('todayFood').innerText = `แนะนำ: ${season.food}`;
            
            const div = document.getElementById('weatherContainer'); div.innerHTML='';
            const front = document.getElementById('cardFront');
            front.classList.remove('theme-winter','theme-summer','theme-rain');
            front.classList.add(`theme-${season.theme}`);
            
            if(season.fx=='rain') { for(let i=0;i<40;i++){ let d=document.createElement('div'); d.className='rain'; d.style.left=Math.random()*100+'%'; d.style.animationDuration=(0.5+Math.random())+'s'; div.appendChild(d); }}
            else if(season.fx=='sun') { let s=document.createElement('div'); s.className='sun-glare'; div.appendChild(s); }
            else { for(let i=0;i<40;i++){ let s=document.createElement('div'); s.className='snowflake'; s.style.left=Math.random()*100+'%'; s.style.animationDuration=(3+Math.random()*2)+'s'; div.appendChild(s); }}
        }

        function createFoodTags(items, id) {
            const c = document.getElementById(id); c.innerHTML='';
            items.forEach(i => {
                let a = document.createElement('a'); a.className='food-tag';
                a.innerHTML = `${i} <i class="fas fa-search text-xs ml-1 text-gray-400"></i>`;
                a.href = `https://www.google.com/search?tbm=isch&q=${i} อาหาร`;
                a.target = '_blank'; c.appendChild(a);
            });
        }

        async function startAnalysis() {
            const d = parseInt(document.getElementById('inputDay').value);
            const m = parseInt(document.getElementById('inputMonth').value);
            const y = parseInt(document.getElementById('inputYear').value);

            let birthDate = new Date(y, m-1, d);
            // Conception Date = Birth Date - 9 Months
            let conceptionDate = new Date(birthDate); 
            conceptionDate.setMonth(birthDate.getMonth()-9);
            
            // Use High Precision Calculation
            const lunar = calendar.getThaiLunarDate(conceptionDate);
            if (!lunar) { alert("วันที่อยู่นอกเหนือช่วงที่รองรับ (พ.ศ. 2446-2599)"); return; }

            // Handle Adhikamas (Month 88) for rule checking
            // Treat 88 as 8 for element checking rules
            let checkMonth = lunar.month;
            if (checkMonth == 88) checkMonth = 8;
            
            // Logic Selection using PDF Rules
            let key = "earth"; 
            let specificHealth = "";
            let range = "";

            for (let rule of sadaoData) {
                if (rule.check(checkMonth, lunar.phase)) {
                    key = rule.baseElement;
                    specificHealth = rule.specificHealth;
                    range = rule.range;
                    break;
                }
            }

            const data = baseElementData[key];
            
            // Gradient Header Logic
            let color="", avatar="";
            if(key.includes("fire")) { color="linear-gradient(135deg, #FF9966, #FF5E62)"; avatar="https://img5.pic.in.th/file/secure-sv1/41a8f63dde1ba7c4b.png"; }
            else if(key.includes("wind")) { color="linear-gradient(135deg, #56ab2f, #a8e063)"; avatar="https://img2.pic.in.th/261c90e765ec6b116.png"; }
            else if(key.includes("water")) { color="linear-gradient(135deg, #36D1DC, #5B86E5)"; avatar="https://img5.pic.in.th/file/secure-sv1/3141eb0166e3e7f51.png"; }
            else { color="linear-gradient(135deg, #CAC531, #F3F9A7)"; avatar="https://img2.pic.in.th/1c8b450894dd6fe8e.png"; }

            document.getElementById('resMain').innerText = data.name;
            document.getElementById('resSub').innerText = range; 
            
            // Verify Box
            document.getElementById('debugCalc').innerText = `(ปฏิสนธิ: ${lunar.display})`;

            document.getElementById('avatarImg').src = avatar;
            document.getElementById('avatarImg').classList.remove('hidden');
            document.getElementById('resultHeader').style.background = color;

            document.getElementById('resTrait').innerText = data.trait;
            document.getElementById('resHealth').innerText = specificHealth; 
            
            document.getElementById('resTasteGood').innerText = data.recTaste;
            document.getElementById('resTasteGoodReason').innerText = data.recReason;
            document.getElementById('resTasteBad').innerText = data.badTaste;
            document.getElementById('resTasteBadReason').innerText = data.badReason;

            createFoodTags(data.foods, 'foodList');
            createFoodTags(data.fruits, 'fruitList');

            document.getElementById('cardObject').classList.add('is-flipped');
            
            // Optional: Log to Google Sheet
            try {
                const birthDateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: "Guest", birthDate: birthDateStr, element: data.name })
                });
            } catch(e) {}
        }

        function resetCard() { document.getElementById('cardObject').classList.remove('is-flipped'); }
    </script>
</body>
</html>
