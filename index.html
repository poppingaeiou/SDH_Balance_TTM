<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>วิเคราะห์ธาตุเจ้าเรือน (ฉบับรพ.สะเดา) - แม่นยำ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-gold: #D4AF37; --deep-green: #1B4D3E; }
        body { font-family: 'Prompt', sans-serif; background: #fdfbf7; overflow-y: auto; }
        .thai-bg {
            background-image: radial-gradient(#1B4D3E 1px, transparent 1px), radial-gradient(#D4AF37 1px, transparent 1px);
            background-size: 24px 24px; background-position: 0 0, 12px 12px; opacity: 0.05; position: absolute; inset: 0; z-index: -1;
        }

        /* Card Layout */
        .card-scene { width: 100%; height: 85vh; max-height: 900px; min-height: 700px; position: relative; perspective: 1000px; margin: 20px 0; }
        .card-object { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(0.4, 0.2, 0.2, 1); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 24px; overflow: hidden; box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.15); }
        .card-front { background: rgba(255, 255, 255, 0.98); border: 1px solid rgba(212, 175, 55, 0.3); transform: rotateY(0deg); }
        
        /* Back Card */
        .card-back { background: white; transform: rotateY(180deg); display: flex; flex-direction: column; height: 100%; }
        .back-header { flex-shrink: 0; position: relative; z-index: 2; }
        .back-content { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 40px; -webkit-overflow-scrolling: touch; } 
        .back-footer { flex-shrink: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); border-top: 1px solid #eee; padding: 15px; z-index: 10; }
        
        .is-flipped { transform: rotateY(180deg); }
        .custom-select { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%231B4D3E' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.2em 1.2em; }

        .avatar-container { height: 150px; display: flex; justify-content: center; align-items: flex-end; margin-bottom: -10px; }
        .avatar-img { height: 140px; width: auto; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        ::-webkit-scrollbar { width: 5px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    
    <div class="thai-bg"></div>

    <div class="text-center mb-2 z-10 animate-fade-in-down flex-shrink-0 mt-4">
        <div class="inline-block p-3 rounded-full bg-white shadow-md border border-green-100 mb-2 relative">
            <i class="fas fa-spa text-3xl text-green-700"></i>
        </div>
        <h1 class="text-xl font-bold text-green-900 tracking-wide">วิเคราะห์ธาตุเจ้าเรือน</h1>
        <p class="text-yellow-700 text-xs font-medium">ฉบับละเอียด (รพ.สะเดา)</p>
    </div>

    <div class="card-scene w-full max-w-sm">
        <div id="cardObject" class="card-object">
            
            <div class="card-face card-front p-6 flex flex-col justify-between">
                <div>
                    <div class="text-center mb-6 mt-4">
                        <h2 class="text-green-800 font-bold text-lg">ระบุวันเกิดของคุณ</h2>
                        <div class="h-1 w-16 bg-gradient-to-r from-yellow-300 to-yellow-500 mx-auto mt-2 rounded-full"></div>
                        <p class="text-xs text-gray-400 mt-2">ระบบจะคำนวณตามปฏิทินจันทรคติ (ข้างขึ้น-ข้างแรม) เพื่อความแม่นยำสูงสุด</p>
                    </div>
                    <div class="space-y-4">
                        <div class="relative">
                            <label class="absolute -top-2.5 left-3 bg-white px-2 text-xs text-green-700 font-bold rounded">วันที่</label>
                            <select id="inputDay" class="custom-select w-full p-3.5 bg-green-50/50 border border-green-200 rounded-xl text-green-900 outline-none focus:ring-2 focus:ring-green-500 transition-shadow font-medium"></select>
                        </div>
                        <div class="relative">
                            <label class="absolute -top-2.5 left-3 bg-white px-2 text-xs text-green-700 font-bold rounded">เดือนเกิด</label>
                            <select id="inputMonth" class="custom-select w-full p-3.5 bg-green-50/50 border border-green-200 rounded-xl text-green-900 outline-none focus:ring-2 focus:ring-green-500 transition-shadow font-medium">
                                <option value="1">มกราคม</option>
                                <option value="2">กุมภาพันธ์</option>
                                <option value="3">มีนาคม</option>
                                <option value="4">เมษายน</option>
                                <option value="5">พฤษภาคม</option>
                                <option value="6">มิถุนายน</option>
                                <option value="7">กรกฎาคม</option>
                                <option value="8">สิงหาคม</option>
                                <option value="9">กันยายน</option>
                                <option value="10">ตุลาคม</option>
                                <option value="11">พฤศจิกายน</option>
                                <option value="12">ธันวาคม</option>
                            </select>
                        </div>
                        <div class="relative">
                            <label class="absolute -top-2.5 left-3 bg-white px-2 text-xs text-green-700 font-bold rounded">ปี พ.ศ.เกิด</label>
                            <select id="inputYear" class="custom-select w-full p-3.5 bg-green-50/50 border border-green-200 rounded-xl text-green-900 outline-none focus:ring-2 focus:ring-green-500 transition-shadow font-medium"></select>
                        </div>
                    </div>
                </div>
                <button onclick="startAnalysis()" class="w-full bg-gradient-to-r from-green-800 to-green-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2 mb-2 group hover:shadow-xl">
                    <span>เริ่มวิเคราะห์ (ละเอียด)</span> <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>

            <div id="resultFace" class="card-face card-back">
                
                <div id="resultHeader" class="back-header h-60 p-4 text-white flex flex-col items-center justify-start bg-gradient-to-br transition-all duration-700">
                    <div class="absolute inset-0 bg-black/10"></div>
                    <div class="avatar-container relative z-10">
                        <img id="avatarImg" src="" alt="3D Avatar" class="avatar-img hidden">
                    </div>
                    <h2 class="text-2xl font-bold drop-shadow-md z-10 mt-1" id="resMain">...</h2>
                    <div class="z-10 flex flex-col items-center">
                         <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded-full backdrop-blur-md z-10 border border-white/30 mb-1" id="resSub">...</span>
                         <span class="text-[9px] text-white/80" id="lunarInfo">...</span>
                    </div>
                </div>

                <div class="back-content space-y-4">
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="text-green-800 font-bold text-sm mb-2"><i class="fas fa-heartbeat bg-green-100 p-1.5 rounded-full text-green-600 mr-2 text-xs"></i> จุดอ่อนสุขภาพเฉพาะคุณ</h3>
                        <p id="resDesc" class="text-gray-600 text-sm leading-relaxed font-medium"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-red-50 p-3 rounded-2xl border border-red-200">
                            <h4 class="font-bold text-red-800 text-xs mb-1"><i class="fas fa-ban mr-1 text-red-600"></i> สิ่งที่ต้องเลี่ยง</h4>
                            <p id="resAvoid" class="text-xs text-gray-600 leading-relaxed"></p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-2xl border border-blue-200">
                            <h4 class="font-bold text-blue-800 text-xs mb-1"><i class="fas fa-user-check mr-1 text-blue-600"></i> ลักษณะนิสัย</h4>
                            <p id="resTrait" class="text-xs text-gray-600 leading-relaxed"></p>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100">
                         <h3 class="text-yellow-800 font-bold text-sm mb-2"><i class="fas fa-utensils bg-yellow-200 p-1.5 rounded-full text-yellow-700 mr-2 text-xs"></i> อาหารปรับสมดุล</h3>
                        <p id="resFood" class="text-gray-600 text-sm leading-relaxed"></p>
                    </div>
                </div>

                <div class="back-footer">
                    <div class="text-center mb-2">
                        <p class="text-[10px] text-gray-400 bg-gray-50 inline-block px-3 py-1 rounded-full border border-gray-100">
                            <i class="fas fa-book mr-1 text-green-600"></i> อ้างอิง: เอกสารวิเคราะห์สมุฏฐาน รพ.สะเดา
                        </p>
                    </div>
                    <button onclick="resetCard()" class="w-full py-3 bg-gray-100 rounded-xl text-gray-600 text-sm font-bold hover:bg-gray-200 transition flex justify-center items-center gap-2">
                        <i class="fas fa-redo"></i> วิเคราะห์ใหม่อีกครั้ง
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="my-4 text-center text-[10px] text-gray-400 opacity-60">
        © 2024 Powered by Google Cloud & Sadao Hospital Innovation
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX7ZJvwflkNzhZ1SPPOJZZcJBvh_Bpbc2acOjh6fEcj58fv9wHu4i9M8J5BoCNmIoDbw/exec'; 

        window.onload = function() {
            const daySelect = document.getElementById('inputDay');
            for(let i=1; i<=31; i++) { let opt = document.createElement('option'); opt.value = i; opt.innerHTML = i; daySelect.appendChild(opt); }
            const yearSelect = document.getElementById('inputYear');
            const currentYearBE = new Date().getFullYear() + 543;
            for(let i=0; i<100; i++) { let y = currentYearBE - i; let opt = document.createElement('option'); opt.value = y - 543; opt.innerHTML = y; yearSelect.appendChild(opt); }
            yearSelect.value = (currentYearBE - 30 - 543);
        }

        // 1. Logic แปลงเดือนสากล -> เดือนไทย (โดยประมาณ)
        function getThaiLunarInfo(day, month) {
            // Mapping เดือนสากล -> เดือนไทย (ประมาณการตามปฏิทินแพทย์แผนไทย)
            // ธ.ค. = เดือน 1 (อ้าย), ม.ค. = เดือน 2 (ยี่) ...
            const monthMap = {
                12: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 
                6: 7, 7: 8, 8: 9, 9: 10, 10: 11, 11: 12
            };
            
            let thaiMonth = monthMap[month];
            
            // Logic ข้างขึ้น/ข้างแรม (โดยประมาณ: 1-15=ขึ้น, 16-31=แรม)
            let phase = (day <= 15) ? "Waxing" : "Waning"; 
            
            return { thaiMonth: thaiMonth, day: day, phase: phase };
        }

        // 2. Database: ข้อมูลจากไฟล์ PDF (Sadao Hospital Rules)
        // Structure: rangeStart (Month), phaseStart (1=Waxing, 2=Waning), ...
        
        const sadaoData = [
            // --- ธาตุดิน (เดือน 1-4) ---
            { 
                startM: 1, startP: "Waning", endM: 2, endP: "Waxing", // แรม 1 ค่ำ เดือน 1 - ขึ้น 15 ค่ำ เดือน 2
                main: "ธาตุดิน (ปถวี)", sub: "ช่วงเดือน 1-2", color: "from-yellow-600 to-brown-700",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Construction%20Worker.png",
                desc: "มีอาการท้องผูก ขับถ่ายลำบาก ปวดท้อง ลมติดในเส้นบ่อย",
                avoid: "อาหารมันที่ย่อยยาก ของทอด",
                trait: "รูปร่างสูงใหญ่ แข็งแรง กระดูกใหญ่ เสียงดังฟังชัด จิตใจหนักแน่น",
                food: "อาหารรสฝาด หวาน มัน เค็ม เช่น ผักกูด, มังคุด, ฟักทอง, เผือก, ถั่วต่างๆ"
            },
            { 
                startM: 2, startP: "Waning", endM: 3, endP: "Waxing", // แรม 1 ค่ำ เดือน 2 - ขึ้น 15 ค่ำ เดือน 3
                main: "ธาตุดิน (ปถวี)", sub: "ช่วงเดือน 2-3", color: "from-yellow-600 to-brown-700",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Lifting%20Weights.png",
                desc: "หายใจไม่สุด หายใจไม่เต็มอิ่ม เหนื่อยง่ายกว่าปกติ",
                avoid: "การทำงานหนักเกินกำลัง พักผ่อนน้อย",
                trait: "รูปร่างสันทัด แข็งแรง แต่อาจมีปัญหาระบบทางเดินหายใจแฝง",
                food: "อาหารรสสุขุม ร้อนเล็กน้อย เช่น น้ำขิง, แกงเลียง"
            },
            { 
                startM: 3, startP: "Waning", endM: 4, endP: "Waxing", // แรม 1 ค่ำ เดือน 3 - ขึ้น 15 ค่ำ เดือน 4
                main: "ธาตุดิน (ปถวี)", sub: "ช่วงเดือน 3-4", color: "from-yellow-600 to-brown-700",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Walking.png",
                desc: "ถ่ายเหลวได้ง่าย ลำไส้แปรปรวน สตรีอาจมีปัญหาประจำเดือน ระบบปัสสาวะ",
                avoid: "อาหารแสลง อาหารรสจัด อาหารหมักดอง",
                trait: "สุขุมรอบคอบ ดื้อรั้นเล็กน้อย",
                food: "อาหารรสฝาดสมาน เช่น กล้วยน้ำว้าดิบ, น้ำฝรั่ง, ยำหัวปลี"
            },

            // --- ธาตุไฟ (เดือน 4-7 และ 8-9) ---
            { 
                startM: 4, startP: "Waning", endM: 5, endP: "Waxing", // แรม 1 ค่ำ เดือน 4 - ขึ้น 15 ค่ำ เดือน 5
                main: "ธาตุไฟ (เตโช)", sub: "ช่วงเดือน 4-5", color: "from-orange-500 to-red-600",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Sweating.png",
                desc: "เป็นลมง่าย หน้ามืด ไข้แดด ร้อนใน นอนหลับยาก",
                avoid: "แสงแดดจัด อารมณ์โมโห เครื่องดื่มแอลกอฮอล์",
                trait: "ผิวขาวเหลือง พูดชัด หิวบ่อย กินจุ ขี้หงุดหงิด",
                food: "อาหารรสจืด เย็น ขม เช่น แตงโม, ต้มจืดฟัก, น้ำเก๊กฮวย"
            },
            { 
                startM: 6, startP: "Waning", endM: 7, endP: "Waxing", // แรม 1 ค่ำ เดือน 6 - ขึ้น 15 ค่ำ เดือน 7
                main: "ธาตุไฟ (เตโช)", sub: "ช่วงเดือน 6-7", color: "from-orange-500 to-red-600",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Running.png",
                desc: "ความดันโลหิตแปรปรวน อารมณ์ขึ้นลงง่าย ตื่นง่าย หลับไม่สนิท",
                avoid: "ความเครียด อาหารรสจัด (เผ็ด/เปรี้ยว/เค็ม)",
                trait: "คล่องแคล่ว โกรธง่ายหายเร็ว ผมหงอกก่อนวัย",
                food: "อาหารรสขมเย็น เช่น แกงจืดมะระ, บรเพ็ด, ใบบัวบก"
            },
            { 
                startM: 8, startP: "Waning", endM: 9, endP: "Waxing", // แรม 1 ค่ำ เดือน 8 - ขึ้น 15 ค่ำ เดือน 9 (ไฟผสมลม)
                main: "ธาตุไฟระคนลม", sub: "ช่วงเดือน 8-9", color: "from-red-500 to-green-500",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Facepalming.png",
                desc: "ปวดศีรษะ ปวดกระบอกตา หูอื้อ วิงเวียนศีรษะ (ไมเกรน)",
                avoid: "แสงแดดจ้า การใช้สายตาเยอะ อาหารรสเผ็ดร้อนเกินไป",
                trait: "คิดเร็วทำเร็ว แต่อาจเครียดลงกระเพาะหรือขึ้นสมองง่าย",
                food: "อาหารรสหอมเย็น จืด เช่น แกงจืดตำลึง, ยาหอม, น้ำดอกไม้"
            },

            // --- ธาตุลม (เดือน 7-10) ---
            { 
                startM: 7, startP: "Waning", endM: 8, endP: "Waxing", // แรม 1 ค่ำ เดือน 7 - ขึ้น 15 ค่ำ เดือน 8
                main: "ธาตุลม (วาโย)", sub: "ช่วงเดือน 7-8", color: "from-emerald-400 to-green-600",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Gesturing%20NO.png",
                desc: "ไอ ระคายเคืองคอ เจ็บคอ จุกคอ ลมตีขึ้นเบื้องบน",
                avoid: "การอดนอน ของทอด น้ำเย็นจัด",
                trait: "ร่างกายผอม ผิวแห้ง ผมบาง พูดเก่ง ขี้กลัว วิตกกังวล",
                food: "อาหารรสเผ็ดร้อนเล็กน้อย ชุ่มคอ เช่น น้ำมะนาวผสมน้ำผึ้ง, ต้มยำไก่"
            },
            { 
                startM: 8, startP: "Waning", endM: 9, endP: "Waxing", // แรม 1 ค่ำ เดือน 8 - ขึ้น 15 ค่ำ เดือน 9 (ซ้ำกับไฟ แต่เน้นอาการลม)
                // *หมายเหตุ: ช่วงนี้คาบเกี่ยวกับธาตุไฟ ในทางปฏิบัติให้ดูอาการประกอบ
                main: "ธาตุลม (วาโย)", sub: "ช่วงเดือน 8-9", color: "from-emerald-400 to-green-600",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Cartwheeling.png",
                desc: "ท้องอืด แน่นท้อง อาหารไม่ย่อย เรอเหม็นเปรี้ยว",
                avoid: "การเคี้ยวอาหารไม่ละเอียด ทานเร็วเกินไป",
                trait: "เคลื่อนไหวเร็ว อารมณ์แปรปรวน",
                food: "สมุนไพรขับลม เช่น ขิง, ข่า, ตะไคร้, กะเพรา"
            },
            { 
                startM: 9, startP: "Waning", endM: 10, endP: "Waxing", // แรม 1 ค่ำ เดือน 9 - ขึ้น 15 ค่ำ เดือน 10
                main: "ธาตุลม (วาโย)", sub: "ช่วงเดือน 9-10", color: "from-emerald-400 to-green-600",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Pouting.png",
                desc: "กรดไหลย้อน ท้องเฟ้อ ท้องบิด แสบร้อนกลางอก อาหารไม่ย่อย",
                avoid: "การอดอาหาร ทานรสจัด กาแฟ อัดลม",
                trait: "คิดมาก วิตกกังวลลงกระเพาะ",
                food: "ขมิ้นชัน, กล้วยน้ำว้า, กระเจี๊ยบเขียว"
            },

            // --- ธาตุน้ำ (เดือน 10-1) ---
            { 
                startM: 10, startP: "Waning", endM: 11, endP: "Waxing", // แรม 1 ค่ำ เดือน 10 - ขึ้น 15 ค่ำ เดือน 11
                main: "ธาตุน้ำ (อาโป)", sub: "ช่วงเดือน 10-11", color: "from-blue-400 to-cyan-600",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Getting%20Massage.png",
                desc: "ปวดในข้อ ปวดเข่า ปวดกระดูก ริดสีดวง ฝี สิว",
                avoid: "อาหารรสหวานจัด มันจัด การนั่งนานๆ",
                trait: "รูปร่างอวบ ผิวขาว ตาโต พูดช้า เสียงไพเราะ",
                food: "อาหารรสเบื่อเมา (แก้ปวด) รสขม เช่น ใบยอ, มะรุม"
            },
            { 
                startM: 11, startP: "Waning", endM: 12, endP: "Waxing", // แรม 1 ค่ำ เดือน 11 - ขึ้น 15 ค่ำ เดือน 12
                main: "ธาตุน้ำ (อาโป)", sub: "ช่วงเดือน 11-12", color: "from-blue-400 to-cyan-600",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Sneezing.png",
                desc: "ภูมิแพ้ หวัด น้ำมูก กรน หายใจติดขัด แน่นหน้าอก",
                avoid: "อากาศเย็นจัด ฝุ่นละออง อาหารฤทธิ์เย็น",
                trait: "เคลื่อนไหวช้า ชอบนอน ใจเย็น",
                food: "อาหารรสเผ็ดร้อน รสเปรี้ยว เช่น ต้มยำ, หอมแดง, กระเทียม"
            },
            { 
                startM: 12, startP: "Waning", endM: 1, endP: "Waxing", // แรม 1 ค่ำ เดือน 12 - ขึ้น 15 ค่ำ เดือน 1
                main: "ธาตุน้ำ (อาโป)", sub: "ช่วงเดือน 12-1", color: "from-blue-400 to-cyan-600",
                avatarUrl: "https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/People/Person%20Shrugging.png",
                desc: "ผดผื่น สิว ลมพิษ คันง่าย ภูมิแพ้ผิวหนัง",
                avoid: "การนอนกลางวันมากเกินไป อาหารหมักดอง",
                trait: "ผิวพรรณละเอียดสวย แต่อาจแพ้ง่าย",
                food: "อาหารรสขม รสจืด เพื่อฟอกเลือด เช่น สะเดา, มะระ, ฟ้าทะลายโจร"
            }
        ];

        // 3. Logic การจับคู่ (Matching Algorithm)
        function getSadaoElement(thaiInfo) {
            let tm = thaiInfo.thaiMonth;
            let tp = thaiInfo.phase; // "Waxing" or "Waning"

            // Loop check
            for (let rule of sadaoData) {
                // เงื่อนไข: ถ้าอยู่ในช่วง (StartM/StartP) ถึง (EndM/EndP)
                // กรณีปกติ (ไม่ข้ามปี)
                if (rule.startM < rule.endM) {
                    // Check Start Boundary
                    let isAfterStart = (tm > rule.startM) || (tm === rule.startM && tp === rule.startP);
                    // Check End Boundary
                    let isBeforeEnd = (tm < rule.endM) || (tm === rule.endM && tp === "Waxing"); // End is always Waxing 15
                    
                    if (isAfterStart && isBeforeEnd) return rule;
                }
                // กรณีข้ามปี (เช่น เดือน 12 -> 1)
                else {
                    let isAfterStart = (tm === rule.startM && tp === rule.startP) || (tm > rule.startM); // e.g. 12 Waning
                    let isBeforeEnd = (tm === rule.endM && tp === "Waxing") || (tm < rule.endM); // e.g. 1 Waxing
                    
                    if (isAfterStart || isBeforeEnd) return rule;
                }
            }
            // Fallback: ถ้าไม่ตรงล็อคเป๊ะๆ ให้ใช้เดือนหลัก
            return sadaoData[0]; 
        }

        async function startAnalysis() {
            const d = parseInt(document.getElementById('inputDay').value);
            const m = parseInt(document.getElementById('inputMonth').value);
            const y = parseInt(document.getElementById('inputYear').value);
            const yAD = y - 543;

            // 1. แปลงเดือนไทย
            const lunarInfo = getThaiLunarInfo(d, m);
            
            // 2. หาธาตุ
            const result = getSadaoElement(lunarInfo);

            // Update UI
            document.getElementById('resMain').innerText = result.main;
            document.getElementById('resSub').innerText = result.sub;
            
            let phaseText = (lunarInfo.phase === "Waxing") ? "ข้างขึ้น" : "ข้างแรม";
            document.getElementById('lunarInfo').innerText = `(ตรงกับ: เดือน ${lunarInfo.thaiMonth} ไทย / ${phaseText} โดยประมาณ)`;

            document.getElementById('resDesc').innerText = result.desc;
            document.getElementById('resAvoid').innerText = result.avoid;
            document.getElementById('resTrait').innerText = result.trait;
            document.getElementById('resFood').innerText = result.food;

            const header = document.getElementById('resultHeader');
            header.className = `back-header h-60 p-4 text-white flex flex-col items-center justify-start bg-gradient-to-br transition-all duration-700 ${result.color}`;
            
            const avatarImg = document.getElementById('avatarImg');
            avatarImg.src = result.avatarUrl;
            avatarImg.classList.remove('hidden');

            document.getElementById('cardObject').classList.add('is-flipped');
            
            try {
                const birthDateStr = `${yAD}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: "Guest", birthDate: birthDateStr, element: result.main, subElement: result.sub })
                });
            } catch(e) {}
        }

        function resetCard() { document.getElementById('cardObject').classList.remove('is-flipped'); }
    </script>
</body>
</html>
