<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>วิเคราะห์ธาตุเจ้าเรือน (Sadao V2.0 - Optimized)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #D4AF37; --green-d: #1B4D3E; --bg: #FDFBF7; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg); color: #333; }
        
        /* Card & Animation */
        .card-scene { width: 100%; max-width: 450px; perspective: 1500px; padding: 20px; }
        .card-object { width: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-face { width: 100%; min-height: 700px; backface-visibility: hidden; border-radius: 24px; background: white; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; }
        .card-back { position: absolute; top: 0; left: 0; transform: rotateY(180deg); display: flex; flex-direction: column; }
        .is-flipped { transform: rotateY(180deg); }

        /* Status UI */
        .section-card { background: #fff; border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid #eee; transition: all 0.3s; }
        .btn-feedback { font-size: 12px; padding: 4px 12px; border-radius: 20px; border: 1px solid #ddd; color: #666; transition: 0.3s; }
        .btn-feedback.active { background: #2E7D32; color: white; border-color: #2E7D32; }
        
        #loading { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 100; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="loading">
        <div class="spinner"></div>
        <p class="mt-4 font-bold text-green-900">กำลังคำนวณตามคัมภีร์...</p>
    </div>

    <div class="card-scene">
        <div id="cardObject" class="card-object">
            
            <div class="card-face p-8 flex flex-col items-center">
                <img src="https://img5.pic.in.th/file/secure-sv1/2613be45e1aa0f1e99dd6a6f89e87139.png" class="w-24 mb-4">
                <h1 class="text-xl font-bold text-gray-800">วิเคราะห์ธาตุเจ้าเรือน</h1>
                <p class="text-xs text-amber-700 mb-8">โรงพยาบาลสะเดา</p>

                <div class="w-full space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 ml-2">วันที่เกิด</label>
                        <select id="inputDay" class="w-full p-3 border rounded-xl outline-none focus:border-amber-500"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 ml-2">เดือนเกิด</label>
                        <select id="inputMonth" class="w-full p-3 border rounded-xl outline-none focus:border-amber-500"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 ml-2">ปี พ.ศ. เกิด</label>
                        <select id="inputYear" class="w-full p-3 border rounded-xl outline-none focus:border-amber-500"></select>
                    </div>
                    <button onclick="processAnalysis()" class="w-full py-4 bg-green-800 text-white rounded-xl font-bold shadow-lg hover:bg-green-700 transition">
                        วิเคราะห์ผล <i class="fas fa-magic ml-2"></i>
                    </button>
                </div>
            </div>

            <div class="card-face card-back">
                <div id="resHeader" class="p-6 text-center text-white">
                    <img id="resAvatar" class="w-20 h-20 mx-auto bg-white rounded-full p-1 mb-2">
                    <h2 id="resTitle" class="text-2xl font-bold">ธาตุ...</h2>
                    <p id="resRange" class="text-xs opacity-80"></p>
                </div>

                <div class="p-4 flex-grow overflow-y-auto">
                    <div class="section-card">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-green-800 text-sm"><i class="fas fa-user-circle"></i> ลักษณะนิสัย</span>
                            <button id="btnTrait" onclick="sendFeedback('trait')" class="btn-feedback"><i class="far fa-thumbs-up"></i> ตรงมาก</button>
                        </div>
                        <p id="resTrait" class="text-sm text-gray-600 leading-relaxed"></p>
                    </div>

                    <div class="section-card border-l-4 border-l-red-400">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-red-800 text-sm"><i class="fas fa-heartbeat"></i> ปัญหาสุขภาพ</span>
                            <button id="btnHealth" onclick="sendFeedback('health')" class="btn-feedback"><i class="far fa-thumbs-up"></i> ตรงมาก</button>
                        </div>
                        <p id="resHealth" class="text-sm text-gray-600 leading-relaxed"></p>
                    </div>

                    <div class="section-card border-l-4 border-l-amber-400">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-amber-800 text-sm"><i class="fas fa-utensils"></i> อาหารปรับสมดุล</span>
                            <button id="btnFood" onclick="sendFeedback('food')" class="btn-feedback"><i class="far fa-thumbs-up"></i> ตรงมาก</button>
                        </div>
                        <div id="resFood" class="text-sm text-gray-600"></div>
                    </div>
                </div>

                <div class="p-4 bg-gray-50">
                    <button onclick="flipBack()" class="w-full py-3 text-gray-500 font-bold">กลับไปแก้ไข</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- ส่วนที่ 1: CONFIG & LOGIC เดิม ---
        const GOOGLE_URL = 'YOUR_GOOGLE_SCRIPT_URL_HERE'; // ใส่ URL ของคุณตรงนี้
        let currentData = {};
        let sessionId = "";

        const adhikamasaYears = [1947,1950,1953,1956,1958,1961,1964,1966,1969,1972,1975,1977,1980,1983,1986,1988,1991,1994,1997,1999,2002,2004,2007,2010,2012,2015,2018,2020,2023,2026,2029,2031,2034,2037,2040,2042,2045,2048,2051,2053,2056,2059,2062,2065,2068];
        
        const baseElements = {
            earth: { name: "ธาตุดิน (ปถวี)", color: "#996633", trait: "รูปร่างสูงใหญ่ หนักแน่น สุขุมรอบคอบ จิตใจมั่นคง ดื้อรั้น", taste: "ฝาด, หวาน, มัน, เค็ม", avatar: "https://img2.pic.in.th/1c8b450894dd6fe8e.png" },
            fire: { name: "ธาตุไฟ (เตโช)", color: "#C62828", trait: "รูปร่างสมส่วน ผิวขาวเหลือง ขี้หงุดหงิด โกรธง่ายหายเร็ว หิวบ่อย", taste: "ขม, เย็น, จืด", avatar: "https://img5.pic.in.th/file/secure-sv1/41a8f63dde1ba7c4b.png" },
            wind: { name: "ธาตุลม (วาโย)", color: "#2E7D32", trait: "ร่างกายผอม ผิวแห้ง ช่างพูด อารมณ์แปรปรวน นอนหลับยาก", taste: "เผ็ดร้อน", avatar: "https://img2.pic.in.th/261c90e765ec6b116.png" },
            water: { name: "ธาตุน้ำ (อาโป)", color: "#1565C0", trait: "รูปร่างอวบ ผิวขาว ใจเย็น เคลื่อนไหวช้า เสียงไพเราะ", taste: "เปรี้ยว, ขม", avatar: "https://img5.pic.in.th/file/secure-sv1/3141eb0166e3e7f51.png" },
            fire_wind: { name: "ธาตุไฟระคนลม", color: "#EF6C00", trait: "ผสมผสาน: หงุดหงิดง่ายแต่ขี้กังวล คิดเร็วทำเร็ว", taste: "จืด, หอมเย็น", avatar: "https://img5.pic.in.th/file/secure-sv1/41a8f63dde1ba7c4b.png" }
        };

        const sadaoRules = [
            { check: (m, p) => (m==1 && p=='Waning') || (m==2 && p=='Waxing'), key: "earth", health: "ท้องผูก ขับถ่ายลำบาก ปวดท้อง ลมติดในเส้น", range: "แรม 1 ค่ำ เดือน 1 - ขึ้น 15 ค่ำ เดือน 2" },
            { check: (m, p) => (m==2 && p=='Waning') || (m==3 && p=='Waxing'), key: "earth", health: "หายใจไม่สุด เหนื่อยง่าย หายใจไม่เต็มอิ่ม", range: "แรม 1 ค่ำ เดือน 2 - ขึ้น 15 ค่ำ เดือน 3" },
            { check: (m, p) => (m==3 && p=='Waning') || (m==4 && p=='Waxing'), key: "earth", health: "ลำไส้แปรปรวน ระบบปัสสาวะ ปัญหาประจำเดือน", range: "แรม 1 ค่ำ เดือน 3 - ขึ้น 15 ค่ำ เดือน 4" },
            { check: (m, p) => (m==4 && p=='Waning') || (m==5 && p=='Waxing'), key: "fire", health: "เป็นลม หน้ามืด ไข้แดด ร้อนใน หลับยาก", range: "แรม 1 ค่ำ เดือน 4 - ขึ้น 15 ค่ำ เดือน 5" },
            { check: (m, p) => (m==5 && p=='Waning') || (m==6 && p=='Waxing'), key: "fire", health: "ร้อนใน กระหายน้ำ ความดันเลือด", range: "แรม 1 ค่ำ เดือน 5 - ขึ้น 15 ค่ำ เดือน 6" },
            { check: (m, p) => (m==6 && p=='Waning') || (m==7 && p=='Waxing'), key: "fire", health: "อารมณ์แปรปรวน นอนหลับยาก ตื่นง่าย", range: "แรม 1 ค่ำ เดือน 6 - ขึ้น 15 ค่ำ เดือน 7" },
            { check: (m, p) => (m==7 && p=='Waning') || (m==8 && p=='Waxing'), key: "wind", health: "ไอ ระคายเคืองคอ จุกคอ ลมตีขึ้น", range: "แรม 1 ค่ำ เดือน 7 - ขึ้น 15 ค่ำ เดือน 8" },
            { check: (m, p) => (m==8 && p=='Waning') || (m==9 && p=='Waxing'), key: "fire_wind", health: "ปวดศีรษะ ปวดกระบอกตา และท้องอืด", range: "แรม 1 ค่ำ เดือน 8 - ขึ้น 15 ค่ำ เดือน 9" },
            { check: (m, p) => (m==9 && p=='Waning') || (m==10 && p=='Waxing'), key: "wind", health: "กรดไหลย้อน ท้องเฟ้อ อาหารไม่ย่อย", range: "แรม 1 ค่ำ เดือน 9 - ขึ้น 15 ค่ำ เดือน 10" },
            { check: (m, p) => (m==10 && p=='Waning') || (m==11 && p=='Waxing'), key: "water", health: "ปวดในข้อ ปวดเข่า ริดสีดวง สิว", range: "แรม 1 ค่ำ เดือน 10 - ขึ้น 15 ค่ำ เดือน 11" },
            { check: (m, p) => (m==11 && p=='Waning') || (m==12 && p=='Waxing'), key: "water", health: "ภูมิแพ้ หวัด น้ำมูก หายใจติดขัด", range: "แรม 1 ค่ำ เดือน 11 - ขึ้น 15 ค่ำ เดือน 12" },
            { check: (m, p) => (m==12 && p=='Waning') || (m==1 && p=='Waxing'), key: "water", health: "ผดผื่น คันง่าย ภูมิแพ้ผิวหนัง", range: "แรม 1 ค่ำ เดือน 12 - ขึ้น 15 ค่ำ เดือน 1" }
        ];

        // --- ส่วนที่ 2: ฟังก์ชันการทำงาน ---
        window.onload = () => {
            initSelectors();
            sessionId = "SID-" + Date.now();
        };

        function initSelectors() {
            const d = document.getElementById('inputDay');
            for(let i=1; i<=31; i++) d.options.add(new Option(i, i));
            const m = document.getElementById('inputMonth');
            ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."].forEach((name, i) => m.options.add(new Option(name, i+1)));
            const y = document.getElementById('inputYear');
            const cur = new Date().getFullYear();
            for(let i=0; i<100; i++) y.options.add(new Option((cur-i)+543, cur-i));
        }

        // Logic คำนวณเดิมเป๊ะๆ
        function getThaiLunar(date) {
            const knownNewMoon = new Date(2000, 0, 6, 18, 14, 0); 
            const diffDays = (date.getTime() - knownNewMoon.getTime()) / (1000 * 3600 * 24);
            let moonAge = (diffDays % 29.53059) + 1.3;
            if (moonAge < 0) moonAge += 29.53059;
            
            let lastNewMoon = new Date(date);
            lastNewMoon.setDate(date.getDate() - Math.floor(moonAge));
            let nmMonth = lastNewMoon.getMonth() + 1;
            const map = {12:1, 1:2, 2:3, 3:4, 4:5, 5:6, 6:7, 7:8, 8:9, 9:10, 10:11, 11:12};
            let thaiMonth = map[nmMonth];
            let phase = (Math.floor(moonAge)+1) <= 15 ? "Waxing" : "Waning";
            
            if (adhikamasaYears.includes(date.getFullYear()) && (nmMonth>=7 || nmMonth<=3)) {
                thaiMonth -= 1; if(thaiMonth<=0) thaiMonth=12;
            }
            return { thaiMonth, phase };
        }

        async function processAnalysis() {
            document.getElementById('loading').style.display = 'flex';
            
            setTimeout(() => {
                const d = parseInt(document.getElementById('inputDay').value);
                const m = parseInt(document.getElementById('inputMonth').value);
                const y = parseInt(document.getElementById('inputYear').value);
                
                let birth = new Date(y, m-1, d);
                let conceive = new Date(birth);
                conceive.setMonth(birth.getMonth()-9);
                
                const lunar = getThaiLunar(conceive);
                let res = sadaoRules.find(r => r.check(lunar.thaiMonth, lunar.phase)) || sadaoRules[0];
                let base = baseElements[res.key];

                // เก็บข้อมูลเตรียมส่ง
                currentData = {
                    sessionId: sessionId,
                    birthDate: `${d}/${m}/${y+543}`,
                    element: base.name,
                    conceptionLunar: `เดือน ${lunar.thaiMonth} (${lunar.phase})`,
                    healthProblem: res.health
                };

                // แสดงผลบนหน้าจอ
                document.getElementById('resHeader').style.background = base.color;
                document.getElementById('resAvatar').src = base.avatar;
                document.getElementById('resTitle').innerText = base.name;
                document.getElementById('resRange').innerText = "ช่วงปฏิสนธิ: " + res.range;
                document.getElementById('resTrait').innerText = base.trait;
                document.getElementById('resHealth').innerText = res.health;
                document.getElementById('resFood').innerHTML = `รสชาติที่ควรทาน: <b>${base.taste}</b>`;

                // Reset Feedback
                document.querySelectorAll('.btn-feedback').forEach(b => {
                    b.classList.remove('active');
                    b.innerHTML = '<i class="far fa-thumbs-up"></i> ตรงมาก';
                });

                document.getElementById('cardObject').classList.add('is-flipped');
                document.getElementById('loading').style.display = 'none';

                // ส่ง Log เข้า Google Sheets (Auto)
                sendLog({ ...currentData, action: 'view' });

            }, 800);
        }

        async function sendLog(data) {
            if(!GOOGLE_URL.includes("macros")) return; 
            try {
                await fetch(GOOGLE_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch(e) { console.error(e); }
        }

        function sendFeedback(type) {
            const btn = document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1));
            if(btn.classList.contains('active')) return;

            btn.classList.add('active');
            btn.innerHTML = '<i class="fas fa-check"></i> ขอบคุณครับ';

            sendLog({
                ...currentData,
                action: 'feedback',
                feedbackType: type,
                isAccurate: 'Yes'
            });
        }

        function flipBack() { document.getElementById('cardObject').classList.remove('is-flipped'); }
    </script>
</body>
</html>
