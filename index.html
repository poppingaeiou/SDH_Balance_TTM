<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>วิเคราะห์ธาตุเจ้าเรือน (Sadao Official)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --gold-main: #D4AF37; 
            --gold-light: #FFF8E1;
            --green-deep: #1B4D3E; 
            --green-leaf: #2E7D32;
            --white-card: #FFFFFF;
        }
        
        body { 
            font-family: 'Prompt', sans-serif; 
            background-color: #FDFBF7;
            /* พื้นหลังลายไทยจางๆ */
            background-image: 
                radial-gradient(var(--gold-main) 0.5px, transparent 0.5px), 
                radial-gradient(var(--green-deep) 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            overflow-y: auto;
            color: #333;
        }

        .thai-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23D4AF37' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none; z-index: -1;
        }

        /* 3D Card Scene - เพิ่ม Padding Top แก้ปัญหาข้อความชิดขอบ */
        .card-scene { 
            width: 100%; max-width: 450px; margin: 0 auto;
            min-height: 100vh; perspective: 1500px; 
            padding: 60px 20px 40px 20px; /* Top padding increased */
        }

        .card-object { 
            width: 100%; position: relative; 
            transform-style: preserve-3d; 
            transition: transform 1.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
        }
        
        .card-face { 
            width: 100%; border-radius: 30px; 
            backface-visibility: hidden; 
            /* Default Background */
            background: white;
            box-shadow: 
                0 20px 50px rgba(27, 77, 62, 0.15),
                0 0 0 1px rgba(212, 175, 55, 0.2) inset;
            overflow: hidden;
            min-height: 800px; 
            display: flex; flex-direction: column;
            transition: background 1s ease; /* Smooth transition for weather bg */
        }
        
        .card-front { 
            transform: rotateY(0deg); 
            position: relative;
            height: 100%;
            display: flex; flex-direction: column;
        }
        
        .card-back { 
            position: absolute; top: 0; left: 0; height: 100%; 
            transform: rotateY(180deg); 
            background: white;
        }
        
        .is-flipped { transform: rotateY(180deg); }

        /* --- WEATHER EFFECTS (Animation) --- */
        .weather-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none; overflow: hidden;
            border-radius: 30px;
        }

        /* Winter Theme (Blue Gradient Background) */
        .theme-winter { background: linear-gradient(to bottom, #E3F2FD 0%, #FFFFFF 80%) !important; }
        /* Summer Theme (Orange Gradient) */
        .theme-summer { background: linear-gradient(to bottom, #FFF3E0 0%, #FFFFFF 80%) !important; }
        /* Rain Theme (Grey Gradient) */
        .theme-rain { background: linear-gradient(to bottom, #ECEFF1 0%, #FFFFFF 80%) !important; }

        /* Snow Effect */
        .snowflake {
            position: absolute; width: 6px; height: 6px; background: white; border-radius: 50%;
            animation: snow-fall linear infinite;
            filter: blur(1px);
            box-shadow: 0 0 5px rgba(255,255,255,0.8);
        }
        @keyframes snow-fall { 
            0% { transform: translateY(-10px) translateX(0); opacity: 0; } 
            20% { opacity: 1; }
            100% { transform: translateY(800px) translateX(30px); opacity: 0; } 
        }

        /* Rain Effect */
        .rain {
            background: linear-gradient(to bottom, rgba(0,0,255,0) 0%, rgba(100,149,237,0.6) 100%);
            height: 40px; position: absolute; width: 2px;
            animation: rain-fall 0.7s linear infinite;
        }
        @keyframes rain-fall { 0% { transform: translateY(-100px); } 100% { transform: translateY(800px); } }

        /* Sun Effect */
        .sun-glare {
            position: absolute; top: -80px; right: -80px; width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(255,160,0,0.3) 0%, rgba(255,255,0,0) 70%);
            animation: sun-pulse 5s ease-in-out infinite;
        }
        @keyframes sun-pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }

        /* Content Wrapper (Z-Index fix) */
        .front-content {
            position: relative; z-index: 10; /* อยู่หน้าสภาพอากาศ */
            padding: 30px;
            display: flex; flex-direction: column; height: 100%;
        }

        /* Logo Animation */
        .logo-container {
            width: 100px; height: 100px; margin: 0 auto 15px;
            background: white; 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border: 3px solid var(--gold-main);
            overflow: hidden;
        }
        .logo-img { width: 90%; height: auto; object-fit: contain; }

        /* Custom Inputs */
        .input-group { position: relative; margin-bottom: 20px; }
        .input-label { 
            position: absolute; top: -10px; left: 15px; 
            background: white; padding: 0 8px; 
            color: var(--green-deep); font-size: 12px; font-weight: bold;
            border-radius: 4px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .custom-select { 
            width: 100%; padding: 16px; border: 1.5px solid rgba(27, 77, 62, 0.2); 
            border-radius: 16px; font-family: 'Prompt'; font-size: 16px; color: #333;
            appearance: none; background-color: rgba(255,255,255,0.9);
            transition: all 0.3s;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%231B4D3E' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.2em;
        }
        .custom-select:focus { border-color: var(--gold-main); box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.2); outline: none; background-color: white; }

        /* Button */
        .btn-gold {
            background: linear-gradient(135deg, var(--green-deep) 0%, #2E7D32 100%);
            color: white; border: none; padding: 18px; width: 100%;
            border-radius: 16px; font-size: 18px; font-weight: bold;
            box-shadow: 0 10px 20px rgba(27, 77, 62, 0.3);
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            position: relative; overflow: hidden;
        }
        .btn-gold:active { transform: scale(0.98); }

        /* Forecast Box */
        .forecast-box {
            margin-top: auto; 
            background: rgba(255, 255, 255, 0.9); /* More opaque for readability */
            backdrop-filter: blur(10px);
            border-radius: 20px; padding: 20px;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        .forecast-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 10px;
        }
        .forecast-title { font-size: 14px; font-weight: bold; color: var(--green-deep); }
        .forecast-date { font-size: 11px; color: #666; font-weight: 500; }
        
        .utu-badge {
            background: var(--green-deep); color: white;
            padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold;
            display: inline-block; margin-bottom: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .warning-text { font-size: 13px; color: #333; line-height: 1.6; margin-bottom: 10px; }
        .food-advice { 
            font-size: 12px; color: #444; background: #F1F8E9; 
            padding: 10px; border-radius: 12px; border: 1px dashed #81C784;
            display: flex; align-items: flex-start;
        }

        /* Results Styling */
        .back-header { 
            background: linear-gradient(135deg, var(--green-deep), #0f3025);
            padding: 20px 20px 40px; text-align: center; color: white;
            border-radius: 0 0 40% 40% / 0 0 30px 30px;
            position: relative; flex-shrink: 0;
        }
        
        .avatar-real {
            width: 140px; height: 140px; margin: -5px auto 5px;
            object-fit: contain;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            animation: float 4s ease-in-out infinite;
            border-radius: 50%;
            background-color: white; 
            border: 4px solid rgba(255,255,255,0.3);
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        .back-content { 
            flex-grow: 1; overflow-y: auto; padding: 20px; 
            margin-top: -30px; z-index: 10;
            -webkit-overflow-scrolling: touch;
        }
        
        .section-title {
            font-size: 14px; font-weight: bold; color: var(--green-deep);
            margin-bottom: 8px; display: flex; align-items: center;
        }
        .section-title i { margin-right: 8px; color: var(--gold-main); }

        .detail-box {
            background: #FAFAFA; border-radius: 12px; padding: 12px; margin-bottom: 12px;
            border-left: 4px solid var(--green-deep);
            font-size: 12px; color: #555; line-height: 1.6;
        }

        .food-tag {
            display: inline-block; padding: 6px 12px; margin: 0 4px 6px 0;
            background: white; border: 1px solid #E0E0E0; border-radius: 20px;
            font-size: 12px; color: #333; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .food-tag:hover {
            background: var(--gold-light); border-color: var(--gold-main);
            transform: translateY(-2px);
        }
        .food-tag i { color: var(--green-leaf); margin-left: 4px; font-size: 10px;}

        .lunar-badge {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            padding: 5px 15px; border-radius: 20px;
            font-size: 12px; color: #FFD700; display: inline-block;
            backdrop-filter: blur(4px);
            margin-bottom: 5px;
        }
        
        .conception-text {
            font-size: 11px; color: rgba(255,255,255,0.8);
            display: inline-block; padding: 2px 8px;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">
    <div class="thai-pattern"></div>

    <div class="card-scene">
        <div id="cardObject" class="card-object">
            
            <div id="cardFront" class="card-face card-front">
                
                <div id="weatherContainer" class="weather-container"></div>

                <div class="front-content">
                    
                    <div class="text-center mb-6">
                        <div class="logo-container">
                            <img src="https://img5.pic.in.th/file/secure-sv1/2613be45e1aa0f1e99dd6a6f89e87139.png" alt="Logo" class="logo-img">
                        </div>
                        <h1 class="text-xl font-bold text-gray-800 tracking-wide">วิเคราะห์ธาตุเจ้าเรือน</h1>
                        <p class="text-yellow-700 text-xs font-medium mt-1">กลุ่มงานการแพทย์แผนไทยฯ รพ.สะเดา</p>
                    </div>

                    <div class="text-center mb-4">
                        <span class="text-xs text-gray-600 bg-white/80 px-3 py-1 rounded-full shadow-sm backdrop-blur-sm border border-white">
                            <i class="fas fa-info-circle mr-1"></i> กรอกวันเกิด (ระบบคำนวณปฏิสนธิอัตโนมัติ)
                        </span>
                    </div>

                    <div class="input-group">
                        <span class="input-label">วันที่</span>
                        <select id="inputDay" class="custom-select"></select>
                    </div>
                    <div class="input-group">
                        <span class="input-label">เดือนเกิด</span>
                        <select id="inputMonth" class="custom-select">
                            <option value="1">มกราคม</option>
                            <option value="2">กุมภาพันธ์</option>
                            <option value="3">มีนาคม</option>
                            <option value="4">เมษายน</option>
                            <option value="5">พฤษภาคม</option>
                            <option value="6">มิถุนายน</option>
                            <option value="7">กรกฎาคม</option>
                            <option value="8">สิงหาคม</option>
                            <option value="9">กันยายน</option>
                            <option value="10">ตุลาคม</option>
                            <option value="11">พฤศจิกายน</option>
                            <option value="12">ธันวาคม</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <span class="input-label">ปี พ.ศ.เกิด</span>
                        <select id="inputYear" class="custom-select"></select>
                    </div>

                    <button onclick="startAnalysis()" class="btn-gold mt-2">
                        <span>วิเคราะห์ธาตุเจ้าเรือน</span> <i class="fas fa-search ml-2"></i>
                    </button>

                    <div class="forecast-box">
                        <div class="forecast-header">
                            <div class="forecast-title"><i class="fas fa-calendar-day mr-1"></i> อุตุสมุฏฐานวันนี้</div>
                            <div class="forecast-date" id="todayDate">...</div>
                        </div>
                        <div>
                            <span class="utu-badge" id="todaySeason">...</span>
                            <p class="warning-text" id="todayHealth">...</p>
                            <div class="food-advice">
                                <i class="fas fa-utensils text-green-600 mr-2 mt-1"></i> 
                                <span id="todayFood">...</span>
                            </div>
                        </div>
                    </div>

                </div> </div>

            <div id="resultFace" class="card-face card-back">
                <div id="resultHeader" class="back-header">
                    <img id="avatarImg" src="" class="avatar-real hidden">
                    <h2 class="text-2xl font-bold text-white drop-shadow-md" id="resMain">...</h2>
                    <p class="text-white/90 text-xs mt-2 px-4 leading-relaxed font-light" id="resSub">...</p>
                    <div class="mt-3 flex flex-col items-center space-y-1">
                        <span class="lunar-badge"><i class="fas fa-dna mr-1"></i> ปฏิสนธิ: <span id="conceptionLunarDisplay">...</span></span>
                        <span class="conception-text">(จากวันเกิด: <span id="birthDateDisplay">...</span>)</span>
                    </div>
                </div>

                <div class="back-content">
                    <div class="section-title"><i class="fas fa-user-circle"></i> ลักษณะนิสัยและจุดเด่น</div>
                    <div class="detail-box" id="resTrait">...</div>

                    <div class="section-title" style="color: #C62828;"><i class="fas fa-heartbeat" style="color:#EF5350;"></i> ความเสี่ยงปัญหาสุขภาพ</div>
                    <div class="detail-box" style="border-left-color: #EF5350; background: #FFEBEE;" id="resHealth">...</div>

                    <div class="section-title"><i class="fas fa-thumbs-up"></i> รสชาติอาหารที่แนะนำ</div>
                    <div class="detail-box" style="border-left-color: #66BB6A; background: #E8F5E9;">
                        <div id="resTasteGood" class="font-bold mb-1"></div>
                        <div id="resTasteGoodReason" class="text-[10px] text-gray-500"></div>
                    </div>

                    <div class="section-title"><i class="fas fa-thumbs-down"></i> รสชาติอาหารที่ควรเลี่ยง</div>
                    <div class="detail-box" style="border-left-color: #FF7043; background: #FBE9E7;">
                        <div id="resTasteBad" class="font-bold mb-1"></div>
                        <div id="resTasteBadReason" class="text-[10px] text-gray-500"></div>
                    </div>

                    <div class="section-title"><i class="fas fa-utensils"></i> เมนูอาหารแนะนำ (กดเพื่อดูรูป)</div>
                    <div id="foodList" class="mb-4"></div>

                    <div class="section-title"><i class="fas fa-lemon"></i> ผลไม้ที่แนะนำ (กดเพื่อดูรูป)</div>
                    <div id="fruitList" class="mb-4"></div>
                </div>

                <div class="p-4 bg-white border-t z-20">
                    <p class="text-[9px] text-center text-gray-400 mb-2">อ้างอิง: คัมภีร์ปฐมจินดา, อุตุสมุฏฐานวินิจฉัย (รพ.สะเดา)</p>
                    <button onclick="resetCard()" class="w-full py-3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition">
                        <i class="fas fa-redo mr-1"></i> วิเคราะห์ใหม่
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX7ZJvwflkNzhZ1SPPOJZZcJBvh_Bpbc2acOjh6fEcj58fv9wHu4i9M8J5BoCNmIoDbw/exec'; 
        const adhikamasaYears = [1947, 1950, 1953, 1956, 1958, 1961, 1964, 1966, 1969, 1972, 1975, 1977, 1980, 1983, 1986, 1988, 1991, 1994, 1997, 1999, 2002, 2004, 2007, 2010, 2012, 2015, 2018, 2020, 2023, 2026, 2029, 2031, 2034, 2037, 2040, 2042, 2045, 2048, 2051, 2053, 2056, 2059, 2062, 2065, 2068];

        window.onload = function() {
            const daySelect = document.getElementById('inputDay');
            for(let i=1; i<=31; i++) { let opt = document.createElement('option'); opt.value = i; opt.innerHTML = i; daySelect.appendChild(opt); }
            const yearSelect = document.getElementById('inputYear');
            const currentYearBE = new Date().getFullYear() + 543;
            for(let i=0; i<100; i++) { 
                let yBE = currentYearBE - i;
                let yAD = yBE - 543;
                let opt = document.createElement('option'); 
                opt.value = yAD; opt.innerHTML = yBE; 
                yearSelect.appendChild(opt); 
            }
            yearSelect.value = (currentYearBE - 30 - 543);
            
            // Trigger Weather & Forecast
            updateDailyForecast();
        }

        // ==========================================
        // 1. Calculation Engine
        // ==========================================
        function calculateRealLunarDate(targetDate) {
            const knownNewMoon = new Date(2000, 0, 6, 18, 14, 0); 
            const diffTime = targetDate.getTime() - knownNewMoon.getTime();
            const diffDays = diffTime / (1000 * 3600 * 24);
            const synodicMonth = 29.53059;
            let moonAge = diffDays % synodicMonth;
            if (moonAge < 0) moonAge += synodicMonth;
            moonAge += 1.3; 
            if (moonAge > synodicMonth) moonAge -= synodicMonth;

            let phase = "";
            let lunarDay = Math.floor(moonAge) + 1;
            if (lunarDay > 30) lunarDay = 1;
            if (lunarDay <= 15) { phase = "Waxing"; } else { phase = "Waning"; lunarDay -= 15; }
            
            let daysToNewMoon = moonAge;
            let lastNewMoonDate = new Date(targetDate);
            lastNewMoonDate.setDate(targetDate.getDate() - Math.floor(daysToNewMoon));
            let nmMonth = lastNewMoonDate.getMonth() + 1; 
            const standardMap = { 11:1, 12:2, 1:3, 2:4, 3:5, 4:6, 5:7, 6:8, 7:9, 8:10, 9:11, 10:12 };
            let thaiMonth = standardMap[nmMonth];

            if (adhikamasaYears.includes(targetDate.getFullYear())) {
                if (nmMonth >= 7 || nmMonth <= 3) { thaiMonth -= 1; if (thaiMonth <= 0) thaiMonth = 12; }
            }
            
            const thaiNums = ["๐","๑","๒","๓","๔","๕","๖","๗","๘","๙"];
            const toThaiNum = (num) => num.toString().split('').map(d => thaiNums[d] || d).join('');
            
            return { phase, lunarDay, thaiMonth, display: `${phase === "Waxing" ? "ขึ้น" : "แรม"} ${toThaiNum(lunarDay)} ค่ำ เดือน ${toThaiNum(thaiMonth)}` };
        }

        // ==========================================
        // 2. Daily Forecast & Dynamic Theme
        // ==========================================
        function getDailySeason(lunar) {
            const m = lunar.thaiMonth;
            
            if (m == 5 || m == 6) return { 
                name: "คิมหันตฤดู (ร้อน)", 
                element: "ธาตุไฟ", 
                health: "อากาศร้อนจัด ความร้อนภายนอกกระทบร่างกาย เสี่ยงต่อลมแดดและขาดน้ำ", 
                food: "ควรทานอาหารรสขม เย็น จืด เพื่อลดความร้อน",
                theme: "summer", fx: "sun"
            };
            if (m == 7 || m == 8) return { 
                name: "วสันตฤดู (ฝนแรก)", 
                element: "ธาตุลมระคนไฟ", 
                health: "อากาศเปลี่ยนแปลง เดี๋ยวร้อนเดี๋ยวฝน ระวังเป็นหวัด วิงเวียนศีรษะ", 
                food: "อาหารรสเปรี้ยว เค็ม เผ็ดเล็กน้อย ช่วยฟอกเลือด",
                theme: "rain", fx: "rain"
            };
            if (m == 9 || m == 10) return { 
                name: "วสสานฤดู (ฝนชุก)", 
                element: "ธาตุลม", 
                health: "ความชื้นสูง เตโชธาตุพิการ(ไฟย่อยไม่ดี) ท้องอืด แน่นท้อง อาหารไม่ย่อย", 
                food: "สมุนไพรขับลม ขิง ข่า ตะไคร้ รสเผ็ดร้อน",
                theme: "rain", fx: "rain"
            };
            if (m == 11 || m == 12) return { 
                name: "สารทฤดู (ปลายฝนต้นหนาว)", 
                element: "ธาตุน้ำ", 
                health: "อากาศเริ่มเย็นลง ระวังเสมหะกำเริบ เจ็บคอ ไอ และปวดเมื่อย", 
                food: "อาหารรสขม รสร้อน ปรับสมดุลน้ำในร่างกาย",
                theme: "winter", fx: "snow"
            };
            if (m == 1 || m == 2) return { 
                name: "เหมันตฤดู (หนาว)", 
                element: "ธาตุน้ำระคนดิน", 
                health: "อากาศหนาวแห้ง โลหิตจับตัว ระวังผิวแห้ง ปวดข้อ น้ำมูกไหล", 
                food: "อาหารรสมัน เค็ม ร้อน ให้ความอบอุ่น",
                theme: "winter", fx: "snow"
            };
            return { 
                name: "ศิศิรฤดู (น้ำค้าง)", 
                element: "ธาตุดิน", 
                health: "ลมหนาวและน้ำค้างแรง ร่างกายสะสมความเย็น ระวังวิงเวียน อ่อนเพลีย", 
                food: "อาหารบำรุงกำลัง รสหวาน มัน เค็ม",
                theme: "winter", fx: "snow"
            };
        }

        function createWeatherFX(type) {
            const container = document.getElementById('weatherContainer');
            container.innerHTML = ''; 
            
            if (type === 'rain') {
                for(let i=0; i<40; i++) {
                    let d = document.createElement('div');
                    d.className = 'rain';
                    d.style.left = Math.random() * 100 + '%';
                    d.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
                    d.style.animationDelay = (Math.random() * 1) + 's';
                    container.appendChild(d);
                }
            } else if (type === 'sun') {
                let s = document.createElement('div');
                s.className = 'sun-glare';
                container.appendChild(s);
            } else if (type === 'snow') {
                for(let i=0; i<40; i++) {
                    let s = document.createElement('div');
                    s.className = 'snowflake';
                    s.style.left = Math.random() * 100 + '%';
                    s.style.animationDuration = (Math.random() * 3 + 3) + 's';
                    s.style.animationDelay = (Math.random() * 2) + 's';
                    s.style.opacity = Math.random() * 0.8 + 0.2;
                    container.appendChild(s);
                }
            }
        }

        function updateDailyForecast() {
            const today = new Date();
            const lunar = calculateRealLunarDate(today);
            const season = getDailySeason(lunar);
            
            // 1. Text Update
            const thaiMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            document.getElementById('todayDate').innerText = `${today.getDate()} ${thaiMonths[today.getMonth()]} ${today.getFullYear()+543}`;
            document.getElementById('todaySeason').innerText = `${season.name}`;
            document.getElementById('todayHealth').innerText = season.health;
            document.getElementById('todayFood').innerText = `แนะนำ: ${season.food}`;
            
            // 2. Theme & FX Update
            const cardFront = document.getElementById('cardFront');
            // Reset Classes
            cardFront.classList.remove('theme-winter', 'theme-summer', 'theme-rain');
            // Add New Class
            if (season.theme) cardFront.classList.add(`theme-${season.theme}`);
            
            createWeatherFX(season.fx);
        }

        // ==========================================
        // 3. Analysis Logic (Same as V.Conception)
        // ==========================================
        function getElementData(month) {
            if (month >= 5 && month <= 7) {
                return {
                    name: "ธาตุไฟ (เตโช)",
                    sub: "ปฏิสนธิในคิมหันตฤดู",
                    color: "linear-gradient(135deg, #FF7043, #D84315)",
                    avatar: "https://img5.pic.in.th/file/secure-sv1/41a8f63dde1ba7c4b.png",
                    trait: "เป็นคนคล่องแคล่ว ว่องไว กระตือรือร้น ใจร้อน หิวบ่อย กินจุ ผิวพรรณมักละเอียด ผิวแดงหรือเหลือง ระบบเผาผลาญดีมาก",
                    health: "มักเป็นไข้ตัวร้อนได้ง่าย เป็นร้อนใน แผลในปาก ปวดศีรษะข้างเดียว (ไมเกรน) ผิวหนังแพ้แสงแดดง่าย",
                    recTaste: "รสขม, รสเย็น, รสจืด",
                    recTasteReason: "ช่วยลดความร้อน ดับพิษร้อนในร่างกาย",
                    avoidTaste: "รสเผ็ดร้อนจัด, รสเค็มจัด",
                    avoidTasteReason: "เพิ่มความร้อน ทำให้ธาตุไฟกำเริบ",
                    foods: ["แกงจืดตำลึง", "แกงจืดมะระ", "ต้มฟักเขียว", "ผัดผักบุ้ง", "แตงกวาผัดไข่", "แกงเลียง", "แกงส้มผักบุ้ง"],
                    fruits: ["แตงโม", "แคนตาลูป", "แก้วมังกร", "ชมพู่", "มังคุด", "ส้มโอ"]
                };
            }
            else if (month >= 8 && month <= 10) {
                return {
                    name: "ธาตุลม (วาโย)",
                    sub: "ปฏิสนธิในวสันตฤดู",
                    color: "linear-gradient(135deg, #66BB6A, #2E7D32)",
                    avatar: "https://img2.pic.in.th/261c90e765ec6b116.png",
                    trait: "ช่างพูดช่างเจรจา คล่องแคล่ว ขี้หนาว ผิวแห้งง่าย รูปร่างโปร่ง ผอมบาง นอนหลับยาก ตื่นง่าย ขี้กังวล",
                    health: "ท้องอืด ท้องเฟ้อ แน่นหน้าอก วิงเวียนศีรษะ หน้ามืดง่าย ปวดตามข้อและกระดูก",
                    recTaste: "รสเผ็ดร้อน, รสสุขุม",
                    recTasteReason: "ช่วยขับลม กระจายเลือดลม แก้ท้องอืด",
                    avoidTaste: "รสหวานจัด, รสมันจัด, รสเย็น",
                    avoidTasteReason: "ทำให้เสมหะเหนียว เลือดลมเดินไม่สะดวก",
                    foods: ["ต้มยำกุ้ง", "ต้มข่าไก่", "แกงป่า", "ผัดกะเพรา", "ขิงผัดไก่", "หมูผัดพริกขิง", "แกงไตปลา"],
                    fruits: ["ส้ม", "เงาะ", "สละ", "ลองกอง", "ลำไย", "ขิง (น้ำขิง)"]
                };
            }
            else if (month == 11 || month == 12 || month == 1) {
                return {
                    name: "ธาตุน้ำ (อาโป)",
                    sub: "ปฏิสนธิในเหมันตฤดู",
                    color: "linear-gradient(135deg, #42A5F5, #1565C0)",
                    avatar: "https://img5.pic.in.th/file/secure-sv1/3141eb0166e3e7f51.png",
                    trait: "รูปร่างสมบูรณ์ ผิวพรรณสดใส เต่งตึง ตาหวาน เสียงไพเราะ เคลื่อนไหวช้า นุ่มนวล อารมณ์เย็น ความจำดี",
                    health: "เป็นหวัดง่าย ภูมิแพ้อากาศ มีเสมหะมาก ท้องเสียบ่อย บวมน้ำง่าย ระบบน้ำเหลืองไม่ดี",
                    recTaste: "รสเปรี้ยว, รสขม, รสร้อน",
                    recTasteReason: "กัดเสมหะ บำรุงโลหิต และขับน้ำส่วนเกิน",
                    avoidTaste: "รสมันจัด, รสหวานจัด, รสเค็มจัด",
                    avoidTasteReason: "ทำให้น้ำเหลืองเสีย เพิ่มเสมหะ",
                    foods: ["แกงส้มดอกแค", "ต้มยำปลา", "ยำตะไคร้", "ห่อหมก", "แกงเหลือง", "น้ำพริกมะขาม", "ส้มตำ"],
                    fruits: ["สับปะรด", "ส้มโอ", "มะเฟือง", "มะขามป้อม", "ตะลิงปลิง"]
                };
            }
            else {
                return {
                    name: "ธาตุดิน (ปถวี)",
                    sub: "ปฏิสนธิในศิศิรฤดู",
                    color: "linear-gradient(135deg, #8D6E63, #5D4037)",
                    avatar: "https://img2.pic.in.th/1c8b450894dd6fe8e.png",
                    trait: "ร่างกายแข็งแรง บึกบึน โครงสร้างใหญ่ หนักแน่น มั่นคง อดทนสูง จิตใจเยือกเย็น สุขุม รอบคอบ",
                    health: "ท้องผูกง่าย อาหารไม่ย่อย โรคอ้วน นิ่ว เนื้องอก ซีสต์",
                    recTaste: "รสฝาด, รสหวาน, รสมัน, รสเค็ม",
                    recTasteReason: "บำรุงธาตุดินให้สมบูรณ์ สมานแผล",
                    avoidTaste: "รสหวานจัดเกินไป, รสมันจัดเกินไป",
                    avoidTasteReason: "ทำให้ธาตุดินกำเริบ เป็นโรคอ้วนง่าย",
                    foods: ["พะโล้", "มัสมั่น", "ราดหน้า", "ผัดซีอิ๊ว", "ยำถั่วพู", "สะตอผัดกุ้ง", "เต้าหู้ทรงเครื่อง"],
                    fruits: ["กล้วยน้ำว้า", "เงาะ", "มังคุด", "ฝรั่ง", "มะละกอ"]
                };
            }
        }

        function createFoodTags(items, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = "";
            items.forEach(item => {
                const tag = document.createElement("a");
                tag.className = "food-tag";
                tag.href = `https://www.google.com/search?tbm=isch&q=${item} อาหาร`; 
                tag.target = "_blank";
                tag.innerHTML = `${item} <i class="fas fa-external-link-alt"></i>`;
                container.appendChild(tag);
            });
        }

        async function startAnalysis() {
            const d = parseInt(document.getElementById('inputDay').value);
            const m = parseInt(document.getElementById('inputMonth').value);
            const yAD = parseInt(document.getElementById('inputYear').value);

            let birthDate = new Date(yAD, m - 1, d);
            let conceptionDate = new Date(birthDate);
            conceptionDate.setMonth(birthDate.getMonth() - 9);
            
            const lunarInfo = calculateRealLunarDate(conceptionDate);
            const data = getElementData(lunarInfo.thaiMonth);

            document.getElementById('resMain').innerText = data.name;
            document.getElementById('resSub').innerText = data.sub; 
            document.getElementById('conceptionLunarDisplay').innerText = lunarInfo.display;
            
            const thaiMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
            document.getElementById('birthDateDisplay').innerText = `${d} ${thaiMonths[m-1]} ${yAD+543}`;

            document.getElementById('avatarImg').src = data.avatar;
            document.getElementById('avatarImg').classList.remove('hidden');
            document.getElementById('resultHeader').style.background = data.color;

            document.getElementById('resTrait').innerText = data.trait;
            document.getElementById('resHealth').innerText = data.health;
            document.getElementById('resTasteGood').innerText = data.recTaste;
            document.getElementById('resTasteGoodReason').innerText = data.recTasteReason;
            document.getElementById('resTasteBad').innerText = data.avoidTaste;
            document.getElementById('resTasteBadReason').innerText = data.avoidTasteReason;

            createFoodTags(data.foods, 'foodList');
            createFoodTags(data.fruits, 'fruitList');

            document.getElementById('cardObject').classList.add('is-flipped');
            
            try {
                const birthDateStr = `${yAD}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                fetch(SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: "Guest", birthDate: birthDateStr, element: data.name })
                });
            } catch(e) {}
        }

        function resetCard() { document.getElementById('cardObject').classList.remove('is-flipped'); }
    </script>
</body>
</html>
