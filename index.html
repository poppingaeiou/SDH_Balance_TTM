<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thai Element Analysis (Sadao Official)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold-main: #D4AF37; --green-deep: #1B4D3E; }
        body { font-family: 'Prompt', sans-serif; background-color: #FDFBF7; color: #333; overflow-x: hidden; }
        
        /* 3D Card */
        .card-scene { width: 100%; max-width: 450px; margin: 0 auto; min-height: 100vh; perspective: 1500px; padding: 40px 20px; }
        .card-object { width: 100%; position: relative; transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .card-face { width: 100%; border-radius: 30px; backface-visibility: hidden; background: white; box-shadow: 0 20px 50px rgba(0,0,0,0.15); min-height: 850px; display: flex; flex-direction: column; overflow: hidden; }
        .card-front { transform: rotateY(0deg); position: relative; background: linear-gradient(to bottom, #ffffff, #f9f9f9); }
        .card-back { position: absolute; top: 0; left: 0; height: 100%; transform: rotateY(180deg); }
        .is-flipped { transform: rotateY(180deg); }

        /* Language Switcher */
        .lang-switch { position: absolute; top: 20px; right: 20px; z-index: 50; background: white; border-radius: 20px; padding: 5px 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; gap: 5px; font-size: 12px; font-weight: bold; border: 1px solid var(--gold-main); }
        .lang-btn { padding: 4px 8px; border-radius: 15px; cursor: pointer; color: #888; }
        .lang-btn.active { background: var(--gold-main); color: white; }

        /* Weather BG */
        .weather-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.6; }
        .theme-winter { background: linear-gradient(to bottom, #90CAF9 0%, #E3F2FD 100%) !important; }
        .theme-summer { background: linear-gradient(to bottom, #FFCC80 0%, #FFF3E0 100%) !important; }
        .theme-rain { background: linear-gradient(to bottom, #B0BEC5 0%, #ECEFF1 100%) !important; }
        /* FX */
        .snowflake { position: absolute; width: 5px; height: 5px; background: #fff; border-radius: 50%; animation: snow-fall linear infinite; box-shadow: 0 0 4px rgba(255,255,255,0.8); }
        @keyframes snow-fall { 0% { transform: translateY(-10px) translateX(0); opacity: 0; } 100% { transform: translateY(900px) translateX(20px); opacity: 0; } }
        .rain { background: linear-gradient(to bottom, rgba(0,0,255,0) 0%, rgba(255,255,255,0.8) 100%); height: 40px; position: absolute; width: 2px; animation: rain-fall 0.7s linear infinite; }
        @keyframes rain-fall { 0% { transform: translateY(-100px); } 100% { transform: translateY(900px); } }
        .sun-glare { position: absolute; top: -80px; right: -80px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,200,0.6) 0%, rgba(255,255,255,0) 70%); animation: sun-pulse 5s ease-in-out infinite; }
        @keyframes sun-pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }

        /* Logo Animation */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .logo-container { width: 100px; height: 100px; margin: 0 auto 20px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid var(--gold-main); animation: float 4s ease-in-out infinite; box-shadow: 0 10px 20px rgba(212,175,55,0.2); }
        .logo-img { width: 90%; }

        /* Inputs (Fixed Z-Index) */
        .input-group { position: relative; margin-bottom: 25px; z-index: 20; }
        .input-label { position: absolute; top: -10px; left: 15px; background: white; padding: 0 8px; color: var(--green-deep); font-size: 13px; font-weight: bold; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 30; }
        .custom-select { width: 100%; padding: 16px; border: 1.5px solid rgba(27,77,62,0.3); border-radius: 16px; font-family: 'Prompt'; background: rgba(255,255,255,0.95); outline: none; appearance: none; pointer-events: auto; }
        
        /* Button */
        .btn-gold { background: linear-gradient(135deg, var(--green-deep), #2E7D32); color: white; padding: 16px; width: 100%; border-radius: 16px; font-weight: bold; box-shadow: 0 10px 20px rgba(27,77,62,0.3); cursor: pointer; position: relative; z-index: 20; }

        /* Forecast Box */
        .forecast-box { margin-top: auto; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; border: 1px solid white; box-shadow: 0 15px 35px rgba(0,0,0,0.1); position: relative; z-index: 10; }
        .utu-badge { background: var(--green-deep); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 8px; }
        .vulnerable-box { background: rgba(255,235,238,0.95); border: 1px dashed #EF5350; border-radius: 10px; padding: 10px; margin-bottom: 10px; font-size: 12px; color: #C62828; display: flex; align-items: center; }

        /* Results (Updated Header) */
        .back-header { padding: 50px 20px 40px; text-align: center; color: white; border-radius: 0 0 40% 40% / 0 0 30px 30px; position: relative; flex-shrink: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .avatar-real { width: 150px; height: 150px; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2)); border-radius: 50%; background: white; border: 4px solid rgba(255,255,255,0.4); margin: 0 auto 10px; }
        .back-content { flex-grow: 1; overflow-y: auto; padding: 20px; margin-top: -30px; z-index: 10; -webkit-overflow-scrolling: touch; }
        
        .section-title { font-size: 15px; font-weight: bold; color: var(--green-deep); margin-bottom: 12px; display: flex; align-items: center; background: linear-gradient(to right, rgba(255,255,255,0.95), rgba(255,255,255,0.7)); padding: 8px 12px; border-radius: 10px; border-left: 4px solid var(--gold-main); box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .detail-box { background: #FAFAFA; border-radius: 16px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.03); font-size: 13px; color: #555; line-height: 1.7; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .food-tag { display: inline-block; padding: 8px 14px; margin: 0 6px 8px 0; background: white; border: 1px solid #E0E0E0; border-radius: 25px; font-size: 12px; color: #333; cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">

    <div class="lang-switch">
        <div id="btn-th" class="lang-btn active" onclick="changeLang('th')">TH</div>
        <div class="lang-btn">|</div>
        <div id="btn-en" class="lang-btn" onclick="changeLang('en')">EN</div>
    </div>

    <div class="card-scene">
        <div id="cardObject" class="card-object">
            
            <div id="cardFront" class="card-face card-front">
                <div id="weatherContainer" class="weather-container"></div>
                <div style="padding: 50px 30px 30px; position: relative; z-index: 10; display: flex; flex-direction: column; height: 100%;">
                    
                    <div class="text-center mb-6">
                        <div class="logo-container"><img src="https://img5.pic.in.th/file/secure-sv1/2613be45e1aa0f1e99dd6a6f89e87139.png" class="logo-img"></div>
                        <h1 class="text-2xl font-bold" data-i18n="app_title">วิเคราะห์ธาตุเจ้าเรือน</h1>
                        <p class="text-sm text-yellow-700 mt-1" data-i18n="app_subtitle">กลุ่มงานการแพทย์แผนไทยฯ รพ.สะเดา</p>
                    </div>

                    <div class="input-group">
                        <span class="input-label" data-i18n="lbl_day">วันที่เกิด</span>
                        <select id="inputDay" class="custom-select"></select>
                    </div>
                    <div class="input-group">
                        <span class="input-label" data-i18n="lbl_month">เดือนเกิด</span>
                        <select id="inputMonth" class="custom-select"></select>
                    </div>
                    <div class="input-group">
                        <span class="input-label" data-i18n="lbl_year">ปีเกิด</span>
                        <select id="inputYear" class="custom-select"></select>
                    </div>

                    <button onclick="startAnalysis()" class="btn-gold mt-4">
                        <span data-i18n="btn_analyze">วิเคราะห์</span> <i class="fas fa-search ml-2"></i>
                    </button>

                    <div class="forecast-box">
                        <div class="flex justify-between items-center mb-2 border-b pb-2 border-gray-100">
                            <span class="text-sm font-bold text-green-900"><i class="fas fa-calendar-day mr-1"></i> <span data-i18n="forecast_title">อุตุสมุฏฐานวันนี้</span></span>
                            <span class="text-xs text-gray-500" id="todayDate">...</span>
                        </div>
                        <span class="utu-badge" id="todaySeason">...</span>
                        <div class="vulnerable-box">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div><span class="font-bold" data-i18n="vul_label">กลุ่มเสี่ยง:</span> <span id="todayVulnerable">...</span></div>
                        </div>
                        <p class="text-xs text-gray-600 mb-2" id="todayHealth">...</p>
                    </div>
                </div>
            </div>

            <div id="resultFace" class="card-face card-back">
                <div id="resultHeader" class="back-header">
                    <img id="avatarImg" src="" class="avatar-real hidden">
                    <h2 class="text-2xl font-bold text-white drop-shadow-md" id="resMain">...</h2>
                    <p class="text-white/90 text-xs mt-1" id="resSub">...</p>
                </div>

                <div class="back-content">
                    <div class="section-title"><i class="fas fa-user-circle"></i> <span data-i18n="res_trait">ลักษณะนิสัย</span></div>
                    <div class="detail-box" id="resTrait">...</div>

                    <div class="section-title" style="color:#C62828; border-color:#EF5350;"><i class="fas fa-heartbeat text-red-500"></i> <span data-i18n="res_health">ปัญหาสุขภาพ</span></div>
                    <div class="detail-box" style="background:#FFEBEE; border-color:#EF5350;" id="resHealth">...</div>

                    <div class="section-title"><i class="fas fa-thumbs-up text-green-600"></i> <span data-i18n="res_good">อาหารที่แนะนำ</span></div>
                    <div class="detail-box" style="background:#E8F5E9; border-color:#66BB6A;">
                        <div id="resTasteGood" class="font-bold mb-1 text-green-800"></div>
                        <div id="resTasteGoodReason" class="text-xs text-gray-600"></div>
                    </div>

                    <div class="section-title"><i class="fas fa-thumbs-down text-red-500"></i> <span data-i18n="res_bad">อาหารที่ควรเลี่ยง</span></div>
                    <div class="detail-box" style="background:#FBE9E7; border-color:#FF7043;">
                        <div id="resTasteBad" class="font-bold mb-1 text-red-800"></div>
                        <div id="resTasteBadReason" class="text-xs text-gray-600"></div>
                    </div>

                    <div class="section-title"><i class="fas fa-utensils"></i> <span data-i18n="res_menu">เมนูแนะนำ</span></div>
                    <div id="foodList" class="mb-4"></div>
                    
                    <div class="section-title"><i class="fas fa-lemon"></i> <span data-i18n="res_fruit">ผลไม้</span></div>
                    <div id="fruitList" class="mb-6"></div>
                </div>

                <div class="p-4 bg-white border-t text-center">
                    <button onclick="resetCard()" class="w-full py-3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition">
                        <i class="fas fa-redo mr-1"></i> <span data-i18n="btn_reset">วิเคราะห์ใหม่</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Define Data and Variables FIRST
        const adhikamasaYears = [1947,1950,1953,1956,1958,1961,1964,1966,1969,1972,1975,1977,1980,1983,1986,1988,1991,1994,1997,1999,2002,2004,2007,2010,2012,2015,2018,2020,2023,2026,2029,2031,2034,2037,2040,2042,2045,2048,2051,2053,2056,2059,2062,2065,2068];
        let currentLang = 'th';

        const i18n = {
            th: { app_title:"วิเคราะห์ธาตุเจ้าเรือน", app_subtitle:"กลุ่มงานการแพทย์แผนไทยฯ รพ.สะเดา", calc_info:"ระบบคำนวณวันปฏิสนธิอัตโนมัติ", lbl_day:"วันที่เกิด", lbl_month:"เดือนเกิด", lbl_year:"ปีเกิด", btn_analyze:"วิเคราะห์ธาตุ", forecast_title:"อุตุสมุฏฐานวันนี้", vul_label:"กลุ่มเสี่ยง:", res_trait:"ลักษณะนิสัย", res_health:"ปัญหาสุขภาพ", res_good:"อาหารแนะนำ", res_bad:"อาหารควรเลี่ยง", res_menu:"เมนูแนะนำ", res_fruit:"ผลไม้", btn_reset:"วิเคราะห์ใหม่", months:["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."], reco:"แนะนำ:" },
            en: { app_title:"Thai Element Analysis", app_subtitle:"Sadao Hospital Traditional Medicine", calc_info:"Auto Conception Calc", lbl_day:"Day", lbl_month:"Month", lbl_year:"Year", btn_analyze:"Analyze", forecast_title:"Today's Season", vul_label:"Vulnerable:", res_trait:"Traits", res_health:"Health Risks", res_good:"Good Foods", res_bad:"Avoid Foods", res_menu:"Menu Ideas", res_fruit:"Fruits", btn_reset:"Reset", months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"], reco:"Advice:" }
        };

        const contentData = {
            fire: {
                th: { name: "ธาตุไฟ (เตโช)", sub: "กำเนิดในคิมหันตฤดู (ฤดูร้อน)", trait: "ใจร้อน ว่องไว ผิวละเอียด เผาผลาญดี", health: "เป็นไข้ ร้อนใน ไมเกรน แพ้แสงแดด", recTaste: "รสขม, รสเย็น, รสจืด", recReason: "ลดความร้อน ฟอกโลหิต", badTaste: "เผ็ดร้อนจัด, เค็มจัด", badReason: "กระตุ้นธาตุไฟให้กำเริบ", foods: ["แกงจืดตำลึง", "ต้มฟัก", "ผัดผักบุ้ง", "แกงส้ม"], fruits: ["แตงโม", "แคนตาลูป", "มังคุด"] },
                en: { name: "Fire Element (Tejo)", sub: "Summer Conception", trait: "Active, impatient, good metabolism", health: "Fever, migraine, sun sensitivity", recTaste: "Bitter, Cooling", recReason: "Reduces heat", badTaste: "Spicy, Salty", badReason: "Increases heat", foods: ["Ivy Gourd Soup", "Winter Melon Soup"], fruits: ["Watermelon", "Mangosteen"] }
            },
            wind: {
                th: { name: "ธาตุลม (วาโย)", sub: "กำเนิดในวสันตฤดู (ฤดูฝน)", trait: "ช่างพูด คล่องแคล่ว ผิวแห้ง ขี้หนาว", health: "ท้องอืด วิงเวียน ปวดข้อ เสียงในหู", recTaste: "เผ็ดร้อน, สุขุม", recReason: "ขับลม ช่วยไหลเวียนเลือด", badTaste: "หวานจัด, มันจัด, เย็น", badReason: "ทำให้อุดตัน เลือดลมเดินไม่สะดวก", foods: ["ต้มยำ", "ข่าไก่", "ผัดกะเพรา", "น้ำขิง"], fruits: ["ส้ม", "เงาะ", "ลำไย", "น้ำขิง"] },
                en: { name: "Wind Element (Vayo)", sub: "Rainy Season Conception", trait: "Talkative, dry skin, dislikes cold", health: "Bloating, dizziness, joint pain", recTaste: "Spicy, Aromatic", recReason: "Expels wind", badTaste: "Sweet, Oily", badReason: "Causes blockage", foods: ["Tom Yum", "Ginger Chicken"], fruits: ["Orange", "Ginger Tea"] }
            },
            water: {
                th: { name: "ธาตุน้ำ (อาโป)", sub: "กำเนิดในเหมันตฤดู (ฤดูหนาว)", trait: "สมบูรณ์ ผิวสดใส นุ่มนวล ความจำดี", health: "หวัด ภูมิแพ้ เสมหะ บวมน้ำง่าย", recTaste: "เปรี้ยว, ขม, ร้อน", recReason: "กัดเสมหะ ขับน้ำส่วนเกิน", badTaste: "มัน, หวาน, เค็ม", badReason: "เพิ่มเสมหะ ทำให้น้ำเหลืองเสีย", foods: ["แกงส้ม", "ต้มยำปลา", "ส้มตำ"], fruits: ["สับปะรด", "ส้มโอ", "มะขามป้อม"] },
                en: { name: "Water Element (Apo)", sub: "Winter Conception", trait: "Full figure, glowing skin, gentle", health: "Colds, allergies, edema", recTaste: "Sour, Bitter, Hot", recReason: "Reduces mucus", badTaste: "Oily, Sweet", badReason: "Increases fluid", foods: ["Sour Curry", "Som Tum"], fruits: ["Pineapple", "Pomelo"] }
            },
            earth: {
                th: { name: "ธาตุดิน (ปถวี)", sub: "กำเนิดในศิศิรฤดู (ฤดูน้ำค้าง)", trait: "แข็งแรง บึกบึน หนักแน่น สุขุม", health: "ท้องผูก นิ่ว เนื้องอก โรคอ้วน", recTaste: "ฝาด, หวาน, มัน, เค็ม", recReason: "บำรุงธาตุ (ทานแต่พอดี)", badTaste: "หวานจัด, มันจัด", badReason: "ทำให้ธาตุดินกำเริบ (อ้วน/ก้อนแข็ง)", foods: ["พะโล้", "ราดหน้า", "ยำถั่วพู"], fruits: ["กล้วย", "ฝรั่ง", "มะละกอ"] },
                en: { name: "Earth Element (Pathavi)", sub: "Late Winter Conception", trait: "Strong, stable, calm", health: "Constipation, obesity, tumors", recTaste: "Astringent, Sweet", recReason: "Nourishes body", badTaste: "Too Sweet/Oily", badReason: "Causes obesity", foods: ["Stew", "Massaman"], fruits: ["Banana", "Papaya"] }
            }
        };

        const seasonData = {
            summer: { th: { name: "คิมหันตฤดู (ร้อน)", vul: "ธาตุไฟ", health: "เสี่ยงลมแดด ร้อนใน", food: "รสขม เย็น จืด" }, en: { name: "Summer", vul: "Fire Element", health: "Heatstroke risk", food: "Bitter/Cooling" } },
            rain: { th: { name: "วสันตฤดู (ฝน)", vul: "ธาตุลม/ไฟ", health: "หวัด วิงเวียน", food: "รสเปรี้ยว เผ็ดร้อน" }, en: { name: "Rainy Season", vul: "Wind/Fire", health: "Cold, Dizziness", food: "Sour/Spicy" } },
            winter: { th: { name: "เหมันตฤดู (หนาว)", vul: "ธาตุน้ำ/ดิน", health: "ผิวแห้ง ปวดข้อ", food: "รสมัน เค็ม ร้อน" }, en: { name: "Winter", vul: "Water/Earth", health: "Dry skin, Joint pain", food: "Oily/Salty/Hot" } }
        };

        const sadaoData = [
            { check: (m, p) => (m==1 && p=='Waning') || (m==2) || (m==3) || (m==4 && p=='Waxing'), key: "earth" },
            { check: (m, p) => (m==4 && p=='Waning') || (m==5 && p=='Waxing') || (m==6 && p=='Waning') || (m==7 && p=='Waxing'), key: "fire" },
            { check: (m, p) => (m==8 && p=='Waning') || (m==9 && p=='Waxing'), key: "fire" }, // Overlap -> use Fire logic as base
            { check: (m, p) => (m==7 && p=='Waning') || (m==8 && p=='Waxing') || (m==9 && p=='Waning') || (m==10 && p=='Waxing'), key: "wind" },
            { check: (m, p) => (m==10 && p=='Waning') || (m==11) || (m==12) || (m==1 && p=='Waxing'), key: "water" }
        ];

        // 2. Main Functions
        window.onload = function() {
            const dS = document.getElementById('inputDay'); for(let i=1; i<=31; i++) { let o = document.createElement('option'); o.value=i; o.innerText=i; dS.appendChild(o); }
            const yS = document.getElementById('inputYear'); const curY = new Date().getFullYear(); 
            for(let i=0; i<100; i++) { let y=curY-i; let o=document.createElement('option'); o.value=y; o.innerText=y+543; yS.appendChild(o); }
            yS.value = curY-30;
            updateUI(); updateDaily();
        }

        function changeLang(l) { currentLang=l; document.getElementById('btn-th').className=`lang-btn ${l=='th'?'active':''}`; document.getElementById('btn-en').className=`lang-btn ${l=='en'?'active':''}`; updateUI(); updateDaily(); if(document.getElementById('cardObject').classList.contains('is-flipped')) startAnalysis(); }
        
        function updateUI() {
            document.querySelectorAll('[data-i18n]').forEach(e => e.innerText = i18n[currentLang][e.getAttribute('data-i18n')]);
            const mS = document.getElementById('inputMonth'); const oldM = mS.value||1; mS.innerHTML=''; 
            i18n[currentLang].months.forEach((m,i)=>{ let o=document.createElement('option'); o.value=i+1; o.innerText=m; mS.appendChild(o); }); mS.value=oldM;
            const yS = document.getElementById('inputYear'); const opts = yS.options;
            for(let i=0; i<opts.length; i++) { let v=parseInt(opts[i].value); opts[i].innerText = currentLang=='th'?(v+543):v; }
        }

        function calculateRealLunarDate(date) {
            const knownNewMoon = new Date(2000, 0, 6, 18, 14, 0); 
            const diffDays = (date.getTime() - knownNewMoon.getTime()) / (1000 * 3600 * 24);
            let moonAge = (diffDays % 29.53059) + 1.3;
            if (moonAge < 0) moonAge += 29.53059; if (moonAge > 29.53059) moonAge -= 29.53059;
            let lastNewMoon = new Date(date); lastNewMoon.setDate(date.getDate() - Math.floor(moonAge));
            let nmMonth = lastNewMoon.getMonth() + 1;
            const map = {12:1, 1:2, 2:3, 3:4, 4:5, 5:6, 6:7, 7:8, 8:9, 9:10, 10:11, 11:12};
            let thaiMonth = map[nmMonth];
            let phase = Math.floor(moonAge) + 1 <= 15 ? "Waxing" : "Waning";
            if (adhikamasaYears.includes(date.getFullYear()) && (nmMonth>=7 || nmMonth<=3)) { thaiMonth -= 1; if(thaiMonth<=0) thaiMonth=12; }
            return { thaiMonth, phase };
        }

        function getDailySeason(m) {
            if (m>=5 && m<=6) return { ...seasonData.summer[currentLang], type:'sun' };
            if (m>=7 && m<=10) return { ...seasonData.rain[currentLang], type:'rain' };
            return { ...seasonData.winter[currentLang], type:'snow' };
        }

        function updateDaily() {
            const today = new Date(); const lunar = calculateRealLunarDate(today); const season = getDailySeason(lunar.thaiMonth);
            document.getElementById('todayDate').innerText = `${today.getDate()} ${i18n[currentLang].months[today.getMonth()]} ${currentLang=='th'?today.getFullYear()+543:today.getFullYear()}`;
            document.getElementById('todaySeason').innerText = season.name;
            document.getElementById('todayVulnerable').innerText = season.vul;
            document.getElementById('todayHealth').innerText = season.health;
            document.getElementById('todayFood').innerText = `${i18n[currentLang].reco} ${season.food}`;
            
            const div = document.getElementById('weatherContainer'); div.innerHTML='';
            const front = document.getElementById('cardFront');
            front.classList.remove('theme-winter','theme-summer','theme-rain');
            
            if(season.type=='rain') {
                front.classList.add('theme-rain');
                for(let i=0;i<30;i++){ let d=document.createElement('div'); d.className='rain'; d.style.left=Math.random()*100+'%'; d.style.animationDuration=(0.5+Math.random())+'s'; div.appendChild(d); }
            } else if(season.type=='sun') {
                front.classList.add('theme-summer');
                let s=document.createElement('div'); s.className='sun-glare'; div.appendChild(s);
            } else {
                front.classList.add('theme-winter');
                for(let i=0;i<30;i++){ let s=document.createElement('div'); s.className='snowflake'; s.style.left=Math.random()*100+'%'; s.style.animationDuration=(3+Math.random()*2)+'s'; div.appendChild(s); }
            }
        }

        function createFoodTags(items, id) {
            const c = document.getElementById(id); c.innerHTML='';
            items.forEach(i => {
                let a = document.createElement('a'); a.className='food-tag';
                a.innerHTML = `${i} <i class="fas fa-search text-xs ml-1 text-gray-400"></i>`;
                a.href = `https://www.google.com/search?tbm=isch&q=${i} ${currentLang=='en'?'Thai food':'อาหาร'}`;
                a.target = '_blank'; c.appendChild(a);
            });
        }

        async function startAnalysis() {
            const d=parseInt(document.getElementById('inputDay').value);
            const m=parseInt(document.getElementById('inputMonth').value);
            const y=parseInt(document.getElementById('inputYear').value);
            const yAD = currentLang=='th' ? y-543 : y;

            let birthDate = new Date(yAD, m-1, d);
            let conceptionDate = new Date(birthDate); conceptionDate.setMonth(birthDate.getMonth()-9);
            
            const lunar = calculateRealLunarDate(conceptionDate);
            
            // Logic Selection using PDF Rules
            let key = "earth"; 
            for (let rule of sadaoData) {
                if (rule.check(lunar.thaiMonth, lunar.phase)) { key = rule.key; break; }
            }

            const data = contentData[key][currentLang];
            
            // Gradient Header Logic
            let color="", avatar="";
            if(key=="fire") { color="linear-gradient(135deg, #FF9966, #FF5E62)"; avatar="https://img5.pic.in.th/file/secure-sv1/41a8f63dde1ba7c4b.png"; }
            else if(key=="wind") { color="linear-gradient(135deg, #56ab2f, #a8e063)"; avatar="https://img2.pic.in.th/261c90e765ec6b116.png"; }
            else if(key=="water") { color="linear-gradient(135deg, #36D1DC, #5B86E5)"; avatar="https://img5.pic.in.th/file/secure-sv1/3141eb0166e3e7f51.png"; }
            else { color="linear-gradient(135deg, #CAC531, #F3F9A7)"; avatar="https://img2.pic.in.th/1c8b450894dd6fe8e.png"; }

            document.getElementById('resMain').innerText = data.name;
            document.getElementById('resSub').innerText = data.sub;
            document.getElementById('avatarImg').src = avatar;
            document.getElementById('avatarImg').classList.remove('hidden');
            document.getElementById('resultHeader').style.background = color;

            document.getElementById('resTrait').innerText = data.trait;
            document.getElementById('resHealth').innerText = data.health;
            document.getElementById('resTasteGood').innerText = data.recTaste;
            document.getElementById('resTasteGoodReason').innerText = data.recReason;
            document.getElementById('resTasteBad').innerText = data.badTaste;
            document.getElementById('resTasteBadReason').innerText = data.badReason;

            createFoodTags(data.foods, 'foodList');
            createFoodTags(data.fruits, 'fruitList');

            document.getElementById('cardObject').classList.add('is-flipped');
        }

        function resetCard() { document.getElementById('cardObject').classList.remove('is-flipped'); }
    </script>
</body>
</html>
