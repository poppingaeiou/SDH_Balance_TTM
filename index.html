<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thai Element Analysis (Sadao Official)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --gold-main: #D4AF37; 
            --gold-light: #FFF8E1;
            --green-deep: #1B4D3E; 
            --green-leaf: #2E7D32;
            --white-card: #FFFFFF;
        }
        
        body { 
            font-family: 'Prompt', sans-serif; 
            background-color: #FDFBF7;
            background-image: 
                radial-gradient(var(--gold-main) 0.5px, transparent 0.5px), 
                radial-gradient(var(--green-deep) 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            overflow-y: auto;
            color: #333;
        }

        .thai-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23D4AF37' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none; z-index: -1;
        }

        /* Language Switcher */
        .lang-switch {
            position: absolute; top: 20px; right: 20px; z-index: 50;
            background: white; border-radius: 20px; padding: 5px 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; gap: 5px; font-size: 12px; font-weight: bold;
            border: 1px solid var(--gold-main);
        }
        .lang-btn {
            padding: 4px 8px; border-radius: 15px; cursor: pointer; transition: all 0.3s; color: #888;
        }
        .lang-btn.active {
            background: var(--gold-main); color: white;
        }

        /* 3D Card Scene */
        .card-scene { 
            width: 100%; max-width: 450px; margin: 0 auto;
            min-height: 100vh; perspective: 1500px; 
            padding: 60px 20px 40px; 
        }

        .card-object { 
            width: 100%; position: relative; 
            transform-style: preserve-3d; 
            transition: transform 1.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
        }
        
        .card-face { 
            width: 100%; border-radius: 30px; 
            backface-visibility: hidden; 
            background: white;
            box-shadow: 0 20px 50px rgba(27, 77, 62, 0.15), 0 0 0 1px rgba(212, 175, 55, 0.2) inset;
            overflow: hidden;
            min-height: 850px; 
            display: flex; flex-direction: column;
            transition: background 1s ease;
        }
        
        .card-front { 
            transform: rotateY(0deg); position: relative; height: 100%;
            display: flex; flex-direction: column;
            background: linear-gradient(to bottom, #ffffff, #f9f9f9);
        }
        
        .card-back { 
            position: absolute; top: 0; left: 0; height: 100%; 
            transform: rotateY(180deg); background: white;
        }
        
        .is-flipped { transform: rotateY(180deg); }

        /* Weather & Themes */
        .weather-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none; overflow: hidden; border-radius: 30px;
        }
        .theme-winter { background: linear-gradient(to bottom, #90CAF9 0%, #E3F2FD 100%) !important; }
        .theme-summer { background: linear-gradient(to bottom, #FFCC80 0%, #FFF3E0 100%) !important; }
        .theme-rain { background: linear-gradient(to bottom, #B0BEC5 0%, #ECEFF1 100%) !important; }

        .snowflake { position: absolute; width: 5px; height: 5px; background: #fff; border-radius: 50%; animation: snow-fall linear infinite; box-shadow: 0 0 4px rgba(255,255,255,0.8); }
        @keyframes snow-fall { 0% { transform: translateY(-10px) translateX(0); opacity: 0; } 100% { transform: translateY(900px) translateX(20px); opacity: 0; } }
        .rain { background: linear-gradient(to bottom, rgba(0,0,255,0) 0%, rgba(255,255,255,0.8) 100%); height: 40px; position: absolute; width: 2px; animation: rain-fall 0.7s linear infinite; }
        @keyframes rain-fall { 0% { transform: translateY(-100px); } 100% { transform: translateY(900px); } }
        .sun-glare { position: absolute; top: -80px; right: -80px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,200,0.6) 0%, rgba(255,255,255,0) 70%); animation: sun-pulse 5s ease-in-out infinite; }
        @keyframes sun-pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }

        /* Front Content */
        .front-content { position: relative; z-index: 10; padding: 50px 30px 30px; display: flex; flex-direction: column; height: 100%; }

        @keyframes logo-float { 0%, 100% { transform: translateY(0); box-shadow: 0 10px 25px rgba(212,175,55,0.3); } 50% { transform: translateY(-8px); box-shadow: 0 20px 35px rgba(212,175,55,0.5); } }
        .logo-container { width: 100px; height: 100px; margin: 0 auto 20px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid var(--gold-main); overflow: hidden; animation: logo-float 4s ease-in-out infinite; }
        .logo-img { width: 90%; height: auto; object-fit: contain; }

        /* Inputs */
        .input-group { position: relative; margin-bottom: 25px; z-index: 20; }
        .input-label { position: absolute; top: -12px; left: 15px; background: #ffffff; padding: 0 10px; color: var(--green-deep); font-size: 13px; font-weight: bold; border-radius: 4px; z-index: 30; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        .custom-select { width: 100%; padding: 16px; border: 1.5px solid rgba(27, 77, 62, 0.3); border-radius: 16px; font-family: 'Prompt'; font-size: 16px; color: #333; appearance: none; background-color: rgba(255,255,255,0.95); transition: all 0.3s; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%231B4D3E' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 1rem center; background-repeat: no-repeat; background-size: 1.2em; }
        .custom-select:focus { border-color: var(--gold-main); box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.2); outline: none; background-color: white; }

        .btn-gold { background: linear-gradient(135deg, var(--green-deep) 0%, #2E7D32 100%); color: white; border: none; padding: 16px; width: 100%; border-radius: 16px; font-size: 18px; font-weight: bold; box-shadow: 0 10px 20px rgba(27, 77, 62, 0.3); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; z-index: 20; }
        .btn-gold:active { transform: scale(0.98); }

        /* Forecast Box */
        .forecast-box { margin-top: auto; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; border: 1px solid white; box-shadow: 0 15px 35px rgba(0,0,0,0.1); position: relative; z-index: 20; }
        .forecast-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 10px; }
        .forecast-title { font-size: 14px; font-weight: bold; color: var(--green-deep); }
        .forecast-date { font-size: 11px; color: #666; font-weight: 500; }
        
        .utu-badge { background: var(--green-deep); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .vulnerable-box { background: rgba(255,235,238,0.95); border: 1px dashed #EF5350; border-radius: 10px; padding: 10px; margin-bottom: 10px; font-size: 12px; color: #C62828; display: flex; align-items: center; }
        .vulnerable-box i { font-size: 16px; margin-right: 8px; }
        .warning-text { font-size: 13px; color: #444; line-height: 1.6; margin-bottom: 10px; }
        .food-advice { font-size: 12px; color: #555; background: rgba(241,248,233,0.95); padding: 10px; border-radius: 10px; border: 1px dashed #81C784; display: flex; align-items: flex-start; }

        /* Results Styling */
        .back-header { 
            padding: 50px 20px 40px; text-align: center; color: white; 
            border-radius: 0 0 40% 40% / 0 0 30px 30px; 
            position: relative; flex-shrink: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .avatar-real { width: 150px; height: 150px; margin: -5px auto 10px; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3)); animation: float 4s ease-in-out infinite; border-radius: 50%; background-color: white; border: 4px solid rgba(255,255,255,0.3); }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .back-content { flex-grow: 1; overflow-y: auto; padding: 20px; margin-top: -30px; z-index: 10; -webkit-overflow-scrolling: touch; }
        
        .section-title { font-size: 15px; font-weight: bold; color: var(--green-deep); margin-bottom: 12px; display: flex; align-items: center; background: linear-gradient(to right, rgba(255,255,255,0.9), rgba(255,255,255,0.5)); padding: 8px 12px; border-radius: 10px; border-left: 4px solid var(--gold-main); box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .section-title i { margin-right: 10px; color: var(--gold-main); font-size: 18px; }
        .detail-box { background: #FAFAFA; border-radius: 16px; padding: 15px; margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.03); font-size: 13px; color: #555; line-height: 1.7; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .food-tag { display: inline-block; padding: 8px 14px; margin: 0 6px 8px 0; background: white; border: 1px solid #E0E0E0; border-radius: 25px; font-size: 12px; color: #333; cursor: pointer; transition: all 0.2s; box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
        .food-tag:hover { background: var(--gold-light); border-color: var(--gold-main); transform: translateY(-2px); }
        .food-tag i { color: var(--green-leaf); margin-left: 4px; font-size: 10px;}
        .lunar-badge { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); padding: 6px 15px; border-radius: 20px; font-size: 13px; color: #FFD700; display: inline-block; backdrop-filter: blur(4px); margin-bottom: 5px; }
        .conception-text { font-size: 11px; color: rgba(255,255,255,0.8); display: inline-block; padding: 2px 8px; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">
    <div class="thai-pattern"></div>

    <div class="lang-switch">
        <div id="btn-th" class="lang-btn active" onclick="changeLang('th')">TH</div>
        <div class="lang-btn">|</div>
        <div id="btn-en" class="lang-btn" onclick="changeLang('en')">EN</div>
    </div>

    <div class="card-scene">
        <div id="cardObject" class="card-object">
            
            <div id="cardFront" class="card-face card-front">
                <div id="weatherContainer" class="weather-container"></div>
                <div class="front-content">
                    
                    <div class="text-center mb-6">
                        <div class="logo-container">
                            <img src="https://img5.pic.in.th/file/secure-sv1/2613be45e1aa0f1e99dd6a6f89e87139.png" alt="Logo" class="logo-img">
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800 tracking-wide drop-shadow-sm" data-i18n="app_title">วิเคราะห์ธาตุเจ้าเรือน</h1>
                        <p class="text-yellow-800 text-sm font-medium mt-1" data-i18n="app_subtitle">กลุ่มงานการแพทย์แผนไทยฯ รพ.สะเดา</p>
                    </div>

                    <div class="text-center mb-6">
                        <span class="text-xs text-gray-600 bg-white/80 px-4 py-2 rounded-full shadow-sm backdrop-blur-sm border border-white font-medium">
                            <i class="fas fa-magic mr-1 text-yellow-600"></i> <span data-i18n="calc_info">ระบบคำนวณวันปฏิสนธิอัตโนมัติ</span>
                        </span>
                    </div>

                    <div class="input-group">
                        <span class="input-label" data-i18n="lbl_day">วันที่เกิด</span>
                        <select id="inputDay" class="custom-select"></select>
                    </div>
                    <div class="input-group">
                        <span class="input-label" data-i18n="lbl_month">เดือนเกิด</span>
                        <select id="inputMonth" class="custom-select"></select>
                    </div>
                    <div class="input-group">
                        <span class="input-label" data-i18n="lbl_year">ปีเกิด</span>
                        <select id="inputYear" class="custom-select"></select>
                    </div>

                    <button onclick="startAnalysis()" class="btn-gold mt-4">
                        <span data-i18n="btn_analyze">วิเคราะห์ธาตุเจ้าเรือน</span> <i class="fas fa-search ml-2"></i>
                    </button>

                    <div class="forecast-box">
                        <div class="forecast-header">
                            <div class="forecast-title"><i class="fas fa-calendar-day mr-1"></i> <span data-i18n="forecast_title">อุตุสมุฏฐานวันนี้</span></div>
                            <div class="forecast-date" id="todayDate">...</div>
                        </div>
                        <div>
                            <span class="utu-badge" id="todaySeason">...</span>
                            <div class="vulnerable-box">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <span class="font-bold" data-i18n="forecast_vul_label">กลุ่มเสี่ยงวันนี้:</span> <span id="todayVulnerable">...</span>
                                </div>
                            </div>
                            <p class="warning-text" id="todayHealth">...</p>
                            <div class="food-advice">
                                <i class="fas fa-utensils text-green-600 mr-2 mt-1"></i> 
                                <span id="todayFood">...</span>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>

            <div id="resultFace" class="card-face card-back">
                <div id="resultHeader" class="back-header">
                    <img id="avatarImg" src="" class="avatar-real hidden">
                    <h2 class="text-2xl font-bold text-white drop-shadow-md" id="resMain">...</h2>
                    <p class="text-white/90 text-xs mt-2 px-4 leading-relaxed font-light" id="resSub">...</p>
                </div>

                <div class="back-content">
                    <div class="section-title"><i class="fas fa-user-circle"></i> <span data-i18n="res_trait">ลักษณะนิสัยและจุดเด่น</span></div>
                    <div class="detail-box" id="resTrait">...</div>

                    <div class="section-title" style="color: #C62828; border-left-color: #EF5350;"><i class="fas fa-heartbeat" style="color:#EF5350;"></i> <span data-i18n="res_health">ความเสี่ยงปัญหาสุขภาพ</span></div>
                    <div class="detail-box" style="background: #FFEBEE; border: 1px dashed #EF5350; border-left: none;" id="resHealth">...</div>

                    <div class="section-title"><i class="fas fa-thumbs-up"></i> <span data-i18n="res_good_food">รสชาติอาหารที่แนะนำ</span></div>
                    <div class="detail-box" style="background: #E8F5E9; border-left-color: #66BB6A;">
                        <div id="resTasteGood" class="font-bold mb-1 text-green-800"></div>
                        <div id="resTasteGoodReason" class="text-xs text-gray-600 mt-1"></div>
                    </div>

                    <div class="section-title"><i class="fas fa-thumbs-down"></i> <span data-i18n="res_bad_food">รสชาติอาหารที่ควรเลี่ยง</span></div>
                    <div class="detail-box" style="background: #FBE9E7; border-left-color: #FF7043;">
                        <div id="resTasteBad" class="font-bold mb-1 text-red-800"></div>
                        <div id="resTasteBadReason" class="text-xs text-gray-600 mt-1"></div>
                    </div>

                    <div class="section-title"><i class="fas fa-utensils"></i> <span data-i18n="res_menu">เมนูอาหารแนะนำ</span></div>
                    <div id="foodList" class="mb-6"></div>

                    <div class="section-title"><i class="fas fa-lemon"></i> <span data-i18n="res_fruit">ผลไม้ที่แนะนำ</span></div>
                    <div id="fruitList" class="mb-4"></div>
                </div>

                <div class="p-4 bg-white border-t z-20">
                    <p class="text-[9px] text-center text-gray-400 mb-2" data-i18n="footer_ref">อ้างอิง: คัมภีร์ปฐมจินดา, อุตุสมุฏฐานวินิจฉัย (รพ.สะเดา)</p>
                    <button onclick="resetCard()" class="w-full py-3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition shadow-md">
                        <i class="fas fa-redo mr-1"></i> <span data-i18n="btn_reset">วิเคราะห์ใหม่</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyX7ZJvwflkNzhZ1SPPOJZZcJBvh_Bpbc2acOjh6fEcj58fv9wHu4i9M8J5BoCNmIoDbw/exec'; 
        const adhikamasaYears = [1947, 1950, 1953, 1956, 1958, 1961, 1964, 1966, 1969, 1972, 1975, 1977, 1980, 1983, 1986, 1988, 1991, 1994, 1997, 1999, 2002, 2004, 2007, 2010, 2012, 2015, 2018, 2020, 2023, 2026, 2029, 2031, 2034, 2037, 2040, 2042, 2045, 2048, 2051, 2053, 2056, 2059, 2062, 2065, 2068];

        // --- I18N DATA ---
        let currentLang = 'th';
        const i18n = {
            th: {
                app_title: "วิเคราะห์ธาตุเจ้าเรือน",
                app_subtitle: "กลุ่มงานการแพทย์แผนไทยฯ รพ.สะเดา",
                calc_info: "ระบบคำนวณวันปฏิสนธิอัตโนมัติ",
                lbl_day: "วันที่เกิด", lbl_month: "เดือนเกิด", lbl_year: "ปีเกิด",
                btn_analyze: "วิเคราะห์ธาตุเจ้าเรือน",
                forecast_title: "อุตุสมุฏฐานวันนี้", forecast_vul_label: "กลุ่มเสี่ยงวันนี้:",
                badge_conception: "ปฏิสนธิ",
                res_trait: "ลักษณะนิสัยและจุดเด่น", res_health: "ความเสี่ยงปัญหาสุขภาพ",
                res_good_food: "รสชาติอาหารที่แนะนำ", res_bad_food: "รสชาติอาหารที่ควรเลี่ยง",
                res_menu: "เมนูอาหารแนะนำ (กดเพื่อดูรูป)", res_fruit: "ผลไม้ที่แนะนำ (กดเพื่อดูรูป)",
                footer_ref: "อ้างอิง: คัมภีร์ปฐมจินดา, อุตุสมุฏฐานวินิจฉัย (รพ.สะเดา)",
                btn_reset: "วิเคราะห์ใหม่",
                months: ["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"],
                reco: "แนะนำ:"
            },
            en: {
                app_title: "Thai Element Analysis",
                app_subtitle: "Sadao Hospital Traditional Medicine",
                calc_info: "Auto-calculate Conception Date",
                lbl_day: "Day of Birth", lbl_month: "Month of Birth", lbl_year: "Year of Birth",
                btn_analyze: "Analyze Element",
                forecast_title: "Today's Seasonal Effect", forecast_vul_label: "Vulnerable Group:",
                badge_conception: "Conception",
                res_trait: "Traits & Personality", res_health: "Health Risks",
                res_good_food: "Recommended Tastes", res_bad_food: "Tastes to Avoid",
                res_menu: "Recommended Dishes (Click to view)", res_fruit: "Recommended Fruits (Click to view)",
                footer_ref: "Ref: Pathom Chinda Scripture, Sadao Hospital",
                btn_reset: "Analyze Again",
                months: ["January","February","March","April","May","June","July","August","September","October","November","December"],
                reco: "Advice:"
            }
        };

        window.onload = function() {
            const daySelect = document.getElementById('inputDay');
            for(let i=1; i<=31; i++) { let opt = document.createElement('option'); opt.value = i; opt.innerHTML = i; daySelect.appendChild(opt); }
            const yearSelect = document.getElementById('inputYear');
            const currentYear = new Date().getFullYear();
            for(let i=0; i<100; i++) { 
                let yAD = currentYear - i; 
                let opt = document.createElement('option'); 
                opt.value = yAD; opt.innerHTML = yAD; 
                yearSelect.appendChild(opt); 
            }
            yearSelect.value = (currentYear - 30);
            
            updateUI();
            updateDailyForecast();
        }

        function changeLang(lang) {
            currentLang = lang;
            document.getElementById('btn-th').className = `lang-btn ${lang==='th'?'active':''}`;
            document.getElementById('btn-en').className = `lang-btn ${lang==='en'?'active':''}`;
            updateUI();
            updateDailyForecast();
            const card = document.getElementById('cardObject');
            if (card.classList.contains('is-flipped')) {
                startAnalysis(); 
            }
        }

        function updateUI() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[currentLang][key]) el.innerText = i18n[currentLang][key];
            });

            const mSelect = document.getElementById('inputMonth');
            const selectedM = mSelect.value || "1";
            mSelect.innerHTML = "";
            i18n[currentLang].months.forEach((m, i) => {
                let opt = document.createElement('option');
                opt.value = i + 1; opt.innerHTML = m;
                mSelect.appendChild(opt);
            });
            mSelect.value = selectedM;

            const ySelect = document.getElementById('inputYear');
            const opts = ySelect.options;
            for(let i=0; i<opts.length; i++) {
                let val = parseInt(opts[i].value);
                opts[i].innerHTML = (currentLang === 'th') ? (val + 543) : val;
            }
        }

        // ==========================================
        // Logic (Calibrated)
        // ==========================================
        function calculateRealLunarDate(targetDate) {
            const knownNewMoon = new Date(2000, 0, 6, 18, 14, 0); 
            const diffTime = targetDate.getTime() - knownNewMoon.getTime();
            const diffDays = diffTime / (1000 * 3600 * 24);
            const synodicMonth = 29.53059;
            let moonAge = diffDays % synodicMonth;
            if (moonAge < 0) moonAge += synodicMonth;
            moonAge += 1.3; 
            if (moonAge > synodicMonth) moonAge -= synodicMonth;

            let phase = "";
            let lunarDay = Math.floor(moonAge) + 1;
            if (lunarDay > 30) lunarDay = 1;
            if (lunarDay <= 15) { phase = "Waxing"; } else { phase = "Waning"; lunarDay -= 15; }
            
            let daysToNewMoon = moonAge;
            let lastNewMoonDate = new Date(targetDate);
            lastNewMoonDate.setDate(targetDate.getDate() - Math.floor(daysToNewMoon));
            let nmMonth = lastNewMoonDate.getMonth() + 1; 
            
            // Correct Mapping: 12=1(Ai), 1=2(Yee), 2=3...
            const standardMap = { 12:1, 1:2, 2:3, 3:4, 4:5, 5:6, 6:7, 7:8, 8:9, 9:10, 10:11, 11:12 };
            let thaiMonth = standardMap[nmMonth];

            if (adhikamasaYears.includes(targetDate.getFullYear())) {
                if (nmMonth >= 7 || nmMonth <= 3) { thaiMonth -= 1; if (thaiMonth <= 0) thaiMonth = 12; }
            }
            return { phase, lunarDay, thaiMonth };
        }

        // --- PDF DATA STRUCTURE (New Sadao Mapping) ---
        // Format: Array of Rules. Each rule checks (month, phase).
        const sadaoData = [
            // EARTH (Waning 1 Month 1 -> Waxing 15 Month 4)
            {
                check: (m, p) => (m==1 && p=='Waning') || (m==2) || (m==3) || (m==4 && p=='Waxing'),
                key: "earth"
            },
            // FIRE (Waning 1 Month 4 -> Waxing 15 Month 5) + (Waning 1 Month 6 -> Waxing 15 Month 7) + (Waning 1 Month 8 -> Waxing 15 Month 9 - Overlap)
            {
                check: (m, p) => (m==4 && p=='Waning') || (m==5 && p=='Waxing'),
                key: "fire"
            },
            {
                check: (m, p) => (m==6 && p=='Waning') || (m==7 && p=='Waxing'),
                key: "fire"
            },
            // Overlap Case 8-9 (Fire + Wind) -> Using "Fire" as primary but merged description if possible, or just standard mapping.
            // Based on PDF: 8-9 appears in BOTH Fire and Wind.
            // Let's create a specific key for this overlap "fire_wind"
            {
                check: (m, p) => (m==8 && p=='Waning') || (m==9 && p=='Waxing'),
                key: "fire_wind" 
            },
            // WIND (Waning 1 Month 7 -> Waxing 15 Month 8) + (Waning 1 Month 9 -> Waxing 15 Month 10)
            {
                check: (m, p) => (m==7 && p=='Waning') || (m==8 && p=='Waxing'),
                key: "wind"
            },
            {
                check: (m, p) => (m==9 && p=='Waning') || (m==10 && p=='Waxing'),
                key: "wind"
            },
            // WATER (Waning 1 Month 10 -> Waxing 15 Month 1)
            {
                check: (m, p) => (m==10 && p=='Waning') || (m==11) || (m==12) || (m==1 && p=='Waxing'),
                key: "water"
            }
        ];

        // Content Data (Enhanced with PDF specifics)
        const contentData = {
            earth: {
                th: {
                    name: "ธาตุดิน (ปถวี)", sub: "ช่วงเดือน 1-4 (ตามจันทรคติ)",
                    trait: "ร่างกายแข็งแรง บึกบึน โครงสร้างใหญ่ หนักแน่น มั่นคง อดทนสูง จิตใจเยือกเย็น สุขุม",
                    health: "ท้องผูกง่าย (ลมติดในเส้น) อาหารไม่ย่อย หายใจไม่เต็มอิ่ม (เดือน 2-3) โรคอ้วน นิ่ว เนื้องอก",
                    recTaste: "รสฝาด, รสหวาน, รสมัน, รสเค็ม", recReason: "บำรุงธาตุดินให้สมบูรณ์ (แต่ต้องทานพอดี)",
                    badTaste: "รสหวานจัดเกินไป, รสมันจัดเกินไป", badReason: "ทำให้ธาตุดินกำเริบจนเป็นก้อนแข็ง (เนื้องอก/อ้วน)",
                    foods: ["พะโล้", "มัสมั่น", "ราดหน้า", "ยำถั่วพู", "สะตอผัดกุ้ง", "เต้าหู้ทรงเครื่อง", "แกงเลียง", "ผักกูด"],
                    fruits: ["กล้วยน้ำว้า", "เงาะ", "มังคุด", "ฝรั่ง", "มะละกอ", "ฟักทอง", "เผือก"]
                },
                en: { name: "Earth Element", sub: "Lunar Month 1-4", trait: "Strong, Stable, Calm", health: "Constipation, Indigestion", recTaste: "Sweet, Oily, Salty", recReason: "Nourishes body", badTaste: "Too Sweet/Oily", badReason: "Causes obesity", foods: ["Stewed Pork", "Massaman"], fruits: ["Banana", "Papaya"] }
            },
            fire: {
                th: {
                    name: "ธาตุไฟ (เตโช)", sub: "ช่วงเดือน 4-5, 6-7 (ตามจันทรคติ)",
                    trait: "คล่องแคล่ว ว่องไว กระตือรือร้น ใจร้อน หิวบ่อย กินจุ ผิวพรรณละเอียด ระบบเผาผลาญดี",
                    health: "เป็นลม หน้ามืด (เดือน 4-5) ความดันโลหิตแปรปรวน (เดือน 6-7) ร้อนใน แผลในปาก",
                    recTaste: "รสขม, รสเย็น, รสจืด", recReason: "ช่วยลดความร้อน ดับพิษร้อนในร่างกาย",
                    badTaste: "รสเผ็ดร้อนจัด, รสเค็มจัด", badReason: "เพิ่มความร้อน ทำให้ธาตุไฟกำเริบ",
                    foods: ["แกงจืดตำลึง", "แกงจืดมะระ", "ต้มฟักเขียว", "ผัดผักบุ้ง", "แตงกวาผัดไข่", "แกงส้ม"],
                    fruits: ["แตงโม", "แคนตาลูป", "แก้วมังกร", "ชมพู่", "มังคุด", "ส้มโอ"]
                },
                en: { name: "Fire Element", sub: "Lunar Month 4-7", trait: "Active, Impatient, Hungry", health: "Fainting, Blood Pressure", recTaste: "Bitter, Cooling", recReason: "Reduces heat", badTaste: "Spicy", badReason: "Increases heat", foods: ["Bitter Melon Soup"], fruits: ["Watermelon"] }
            },
            fire_wind: { // Special Overlap Month 8-9
                th: {
                    name: "ธาตุไฟระคนลม", sub: "ช่วงเดือน 8-9 (ตามจันทรคติ)",
                    trait: "คิดเร็วทำเร็ว หงุดหงิดง่าย (ไฟ) แต่ก็ขี้กังวลและเคลื่อนไหวเร็ว (ลม)",
                    health: "ปวดศีรษะ ปวดกระบอกตา หูอื้อ (ไมเกรน) และอาจมีอาการท้องอืดร่วมด้วย",
                    recTaste: "รสหอมเย็น, รสจืด", recReason: "แก้วิงเวียนและดับพิษร้อน",
                    badTaste: "รสเผ็ดจัด, แสงแดดจ้า", badReason: "กระตุ้นอาการปวดหัวและลมในเส้น",
                    foods: ["แกงจืดตำลึง", "ยาหอม", "น้ำดอกไม้", "แกงส้ม"],
                    fruits: ["แตงโม", "ส้มโอ", "แก้วมังกร"]
                },
                en: { name: "Fire & Wind Mix", sub: "Lunar Month 8-9", trait: "Quick thinker, Anxious", health: "Migraine, Dizziness, Bloating", recTaste: "Aromatic, Bland", recReason: "Calms senses", badTaste: "Very Spicy", badReason: "Triggers migraine", foods: ["Clear Soup"], fruits: ["Pomelo"] }
            },
            wind: {
                th: {
                    name: "ธาตุลม (วาโย)", sub: "ช่วงเดือน 7-8, 9-10 (ตามจันทรคติ)",
                    trait: "ช่างพูด เจรจาเก่ง รูปร่างโปร่ง ผิวแห้งง่าย นอนหลับยาก คิดเร็ว",
                    health: "ไอ ระคายคอ (เดือน 7-8) กรดไหลย้อน ท้องเฟ้อ (เดือน 9-10) วิงเวียน",
                    recTaste: "รสเผ็ดร้อน, รสสุขุม", recReason: "ช่วยขับลม กระจายเลือดลม แก้ท้องอืด",
                    badTaste: "รสหวานจัด, รสมันจัด, รสเย็น", badReason: "ทำให้เสมหะเหนียวข้น เลือดลมเดินไม่สะดวก",
                    foods: ["ต้มยำกุ้ง", "ต้มข่าไก่", "แกงป่า", "ผัดกะเพรา", "ไก่ผัดขิง", "น้ำพริกขิง"],
                    fruits: ["ส้ม", "เงาะ", "สละ", "ลองกอง", "ลำไย", "น้ำขิง"]
                },
                en: { name: "Wind Element", sub: "Lunar Month 7-8, 9-10", trait: "Talkative, Slender, Dry Skin", health: "Cough, Acid Reflux", recTaste: "Spicy", recReason: "Expels wind", badTaste: "Sweet, Oily", badReason: "Blocks flow", foods: ["Tom Yum"], fruits: ["Ginger Tea"] }
            },
            water: {
                th: {
                    name: "ธาตุน้ำ (อาโป)", sub: "ช่วงเดือน 10-1 (ตามจันทรคติ)",
                    trait: "รูปร่างสมบูรณ์ ผิวสดใส ตาหวาน เสียงไพเราะ เคลื่อนไหวช้า นุ่มนวล",
                    health: "ปวดข้อ เข่า (เดือน 10-11) ภูมิแพ้ หวัด (เดือน 11-12) ผดผื่นคัน (เดือน 12-1)",
                    recTaste: "รสเปรี้ยว, รสขม, รสร้อน", recReason: "ช่วยกัดเสมหะ บำรุงโลหิต และขับน้ำส่วนเกิน",
                    badTaste: "รสมันจัด, รสหวานจัด, รสเค็มจัด", badReason: "ทำให้น้ำเหลืองเสีย เพิ่มเสมหะ และตัวบวมง่าย",
                    foods: ["แกงส้มดอกแค", "ต้มยำปลา", "ห่อหมก", "แกงเหลือง", "น้ำพริกมะขาม", "ส้มตำ", "ใบยอ"],
                    fruits: ["สับปะรด", "ส้มโอ", "มะเฟือง", "มะขามป้อม", "ตะลิงปลิง"]
                },
                en: { name: "Water Element", sub: "Lunar Month 10-1", trait: "Full figure, Slow, Gentle", health: "Joint pain, Allergies, Rashes", recTaste: "Sour, Bitter, Hot", recReason: "Reduces mucus", badTaste: "Oily, Sweet", badReason: "Increases mucus", foods: ["Sour Curry"], fruits: ["Pineapple"] }
            }
        };

        const seasonData = {
            summer: { th: { name: "คิมหันตฤดู (ร้อน)", vul: "ผู้มีธาตุไฟ", health: "เสี่ยงลมแดด ร้อนใน", food: "อาหารรสขม เย็น จืด" }, en: { name: "Summer", vul: "Fire Element", health: "Heatstroke risk", food: "Bitter/Cooling foods" } },
            rain: { th: { name: "วสันตฤดู (ฝน)", vul: "ผู้มีธาตุลม/ไฟ", health: "ระวังไข้หวัด วิงเวียน", food: "อาหารรสเปรี้ยว เผ็ดร้อน" }, en: { name: "Rainy Season", vul: "Wind/Fire Element", health: "Colds, Dizziness", food: "Sour/Spicy foods" } },
            winter: { th: { name: "เหมันตฤดู (หนาว)", vul: "ผู้มีธาตุน้ำ/ดิน", health: "ผิวแห้ง ปวดข้อ น้ำมูก", food: "อาหารรสมัน เค็ม ร้อน" }, en: { name: "Winter", vul: "Water/Earth Element", health: "Dry skin, Joint pain", food: "Oily/Salty/Hot foods" } }
        };

        const i18n = {
            th: { app_title:"วิเคราะห์ธาตุเจ้าเรือน", app_subtitle:"กลุ่มงานการแพทย์แผนไทยฯ รพ.สะเดา", calc_info:"ระบบคำนวณวันปฏิสนธิอัตโนมัติ", lbl_day:"วันที่เกิด", lbl_month:"เดือนเกิด", lbl_year:"ปีเกิด", btn_analyze:"วิเคราะห์ธาตุ", forecast_title:"อุตุสมุฏฐานวันนี้", vul_label:"กลุ่มเสี่ยง:", res_trait:"ลักษณะนิสัย", res_health:"ปัญหาสุขภาพ", res_good:"อาหารแนะนำ", res_bad:"อาหารควรเลี่ยง", res_menu:"เมนูแนะนำ", res_fruit:"ผลไม้", btn_reset:"วิเคราะห์ใหม่", months:["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."], reco:"แนะนำ:" },
            en: { app_title:"Thai Element Analysis", app_subtitle:"Sadao Hospital Traditional Medicine", calc_info:"Auto Conception Calc", lbl_day:"Day", lbl_month:"Month", lbl_year:"Year", btn_analyze:"Analyze", forecast_title:"Today's Season", vul_label:"Vulnerable:", res_trait:"Traits", res_health:"Health Risks", res_good:"Good Foods", res_bad:"Avoid Foods", res_menu:"Menu Ideas", res_fruit:"Fruits", btn_reset:"Reset", months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"], reco:"Advice:" }
        };

        window.onload = function() {
            const dS = document.getElementById('inputDay'); for(let i=1; i<=31; i++) { let o = document.createElement('option'); o.value=i; o.innerText=i; dS.appendChild(o); }
            const yS = document.getElementById('inputYear'); const curY = new Date().getFullYear(); 
            for(let i=0; i<100; i++) { let y=curY-i; let o=document.createElement('option'); o.value=y; o.innerText=y+543; yS.appendChild(o); }
            yS.value = curY-30;
            updateUI(); updateDaily();
        }

        function changeLang(l) { currentLang=l; document.getElementById('btn-th').className=`lang-btn ${l=='th'?'active':''}`; document.getElementById('btn-en').className=`lang-btn ${l=='en'?'active':''}`; updateUI(); updateDaily(); if(document.getElementById('cardObject').classList.contains('is-flipped')) startAnalysis(); }
        
        function updateUI() {
            document.querySelectorAll('[data-i18n]').forEach(e => e.innerText = i18n[currentLang][e.getAttribute('data-i18n')]);
            const mS = document.getElementById('inputMonth'); const oldM = mS.value||1; mS.innerHTML=''; 
            i18n[currentLang].months.forEach((m,i)=>{ let o=document.createElement('option'); o.value=i+1; o.innerText=m; mS.appendChild(o); }); mS.value=oldM;
            const yS = document.getElementById('inputYear'); const opts = yS.options;
            for(let i=0; i<opts.length; i++) { let v=parseInt(opts[i].value); opts[i].innerText = currentLang=='th'?(v+543):v; }
        }

        function getDailySeason(m) {
            if (m>=5 && m<=6) return { ...seasonData.summer[currentLang], type:'sun' };
            if (m>=7 && m<=10) return { ...seasonData.rain[currentLang], type:'rain' };
            return { ...seasonData.winter[currentLang], type:'snow' };
        }

        function updateDaily() {
            const today = new Date();
            const lunar = calculateRealLunarDate(today);
            const season = getDailySeason(lunar.thaiMonth);
            
            document.getElementById('todayDate').innerText = `${today.getDate()} ${i18n[currentLang].months[today.getMonth()]} ${currentLang=='th'?today.getFullYear()+543:today.getFullYear()}`;
            document.getElementById('todaySeason').innerText = season.name;
            document.getElementById('todayVulnerable').innerText = season.vul;
            document.getElementById('todayHealth').innerText = season.health;
            
            const div = document.getElementById('weatherContainer'); div.innerHTML='';
            const front = document.getElementById('cardFront');
            front.classList.remove('theme-winter','theme-summer','theme-rain');
            
            if(season.type=='rain') {
                front.classList.add('theme-rain');
                for(let i=0;i<30;i++){ let d=document.createElement('div'); d.className='rain'; d.style.left=Math.random()*100+'%'; d.style.animationDuration=(0.5+Math.random())+'s'; div.appendChild(d); }
            } else if(season.type=='sun') {
                front.classList.add('theme-summer');
                let s=document.createElement('div'); s.className='sun-glare'; div.appendChild(s);
            } else {
                front.classList.add('theme-winter');
                for(let i=0;i<30;i++){ let s=document.createElement('div'); s.className='snowflake'; s.style.left=Math.random()*100+'%'; s.style.animationDuration=(3+Math.random()*2)+'s'; div.appendChild(s); }
            }
        }

        function createFoodTags(items, id) {
            const c = document.getElementById(id); c.innerHTML='';
            items.forEach(i => {
                let a = document.createElement('a'); a.className='food-tag';
                a.innerHTML = `${i} <i class="fas fa-search text-xs ml-1 text-gray-400"></i>`;
                a.href = `https://www.google.com/search?tbm=isch&q=${i} ${currentLang=='en'?'Thai food':'อาหาร'}`;
                a.target = '_blank'; c.appendChild(a);
            });
        }

        async function startAnalysis() {
            const d=parseInt(document.getElementById('inputDay').value);
            const m=parseInt(document.getElementById('inputMonth').value);
            const y=parseInt(document.getElementById('inputYear').value);
            const yAD = currentLang=='th' ? y-543 : y;

            let birthDate = new Date(yAD, m-1, d);
            let conceptionDate = new Date(birthDate); conceptionDate.setMonth(birthDate.getMonth()-9);
            
            const lunar = calculateRealLunarDate(conceptionDate);
            
            // Logic Selection using PDF Rules
            let key = "earth"; // Default fallback
            for (let rule of sadaoData) {
                if (rule.check(lunar.thaiMonth, lunar.phase)) {
                    key = rule.key;
                    break;
                }
            }

            const data = contentData[key][currentLang];
            
            // Map Colors
            let color="", avatar="";
            if(key.includes("fire")) { color="linear-gradient(135deg, #FF9966, #FF5E62)"; avatar="https://img5.pic.in.th/file/secure-sv1/41a8f63dde1ba7c4b.png"; }
            else if(key.includes("wind")) { color="linear-gradient(135deg, #56ab2f, #a8e063)"; avatar="https://img2.pic.in.th/261c90e765ec6b116.png"; }
            else if(key.includes("water")) { color="linear-gradient(135deg, #36D1DC, #5B86E5)"; avatar="https://img5.pic.in.th/file/secure-sv1/3141eb0166e3e7f51.png"; }
            else { color="linear-gradient(135deg, #CAC531, #F3F9A7)"; avatar="https://img2.pic.in.th/1c8b450894dd6fe8e.png"; }

            document.getElementById('resMain').innerText = data.name;
            document.getElementById('resSub').innerText = data.sub;
            document.getElementById('avatarImg').src = avatar;
            document.getElementById('avatarImg').classList.remove('hidden');
            document.getElementById('resultHeader').style.background = color;

            document.getElementById('resTrait').innerText = data.trait;
            document.getElementById('resHealth').innerText = data.health;
            document.getElementById('resTasteGood').innerText = data.recTaste;
            document.getElementById('resTasteGoodReason').innerText = data.recReason;
            document.getElementById('resTasteBad').innerText = data.badTaste;
            document.getElementById('resTasteBadReason').innerText = data.badReason;

            createFoodTags(data.foods, 'foodList');
            createFoodTags(data.fruits, 'fruitList');

            document.getElementById('cardObject').classList.add('is-flipped');
        }

        function resetCard() { document.getElementById('cardObject').classList.remove('is-flipped'); }
    </script>
</body>
</html>
